<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>Notes from a data witch: Data types in Arrow and R</title>

<meta property="description" itemprop="description" content="A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um... long"/>

<link rel="canonical" href="https://blog.djnavarro.net/data-types-in-arrow-and-r/"/>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2022-03-04"/>
<meta property="article:created" itemprop="dateCreated" content="2022-03-04"/>
<meta name="article:author" content="Danielle Navarro"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Notes from a data witch: Data types in Arrow and R"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um... long"/>
<meta property="og:url" content="https://blog.djnavarro.net/data-types-in-arrow-and-r/"/>
<meta property="og:image" content="https://blog.djnavarro.net/posts/2022-03-04_data-types-in-arrow-and-r/img/cover.jpg"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Notes from a data witch"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Notes from a data witch: Data types in Arrow and R"/>
<meta property="twitter:description" content="A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um... long"/>
<meta property="twitter:url" content="https://blog.djnavarro.net/data-types-in-arrow-and-r/"/>
<meta property="twitter:image" content="https://blog.djnavarro.net/posts/2022-03-04_data-types-in-arrow-and-r/img/cover.jpg"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="Notes from a data witch: Data types in Arrow and R"/>
<meta name="citation_fulltext_html_url" content="https://blog.djnavarro.net/data-types-in-arrow-and-r"/>
<meta name="citation_fulltext_world_readable" content=""/>
<meta name="citation_online_date" content="2022/03/04"/>
<meta name="citation_publication_date" content="2022/03/04"/>
<meta name="citation_author" content="Danielle Navarro"/>
<meta name="citation_author_institution" content="Voltron Data"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","preview","creative_commons","citation_url","repository_url","output","params","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Data types in Arrow and R"]},{"type":"character","attributes":{},"value":["A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um... long"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["first_name","last_name","url","affiliation","affiliation_url","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["Danielle"]},{"type":"character","attributes":{},"value":["Navarro"]},{"type":"character","attributes":{},"value":["https://djnavarro.net"]},{"type":"character","attributes":{},"value":["Voltron Data"]},{"type":"character","attributes":{},"value":["https://voltrondata.com"]},{"type":"character","attributes":{},"value":["0000-0001-7648-6578"]}]}]},{"type":"character","attributes":{},"value":["2022-03-04"]},{"type":"character","attributes":{},"value":["img/cover.jpg"]},{"type":"character","attributes":{},"value":["CC BY"]},{"type":"character","attributes":{},"value":["https://blog.djnavarro.net/data-types-in-arrow-and-r"]},{"type":"character","attributes":{},"value":["https://github.com/djnavarro/distill-blog/"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["slug","date","repo","site"]}},"value":[{"type":"character","attributes":{},"value":["data-types-in-arrow-and-r"]},{"type":"character","attributes":{},"value":["2022-03-04"]},{"type":"character","attributes":{},"value":["djnavarro/distill-blog"]},{"type":"character","attributes":{},"value":["https://blog.djnavarro.net/"]}]},{"type":"character","attributes":{},"value":["https://blog.djnavarro.net/data-types-in-arrow-and-r/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["art/pollen_46_4628.jpg","art/pollen_46_4699.jpg","art/pollen_47_4783.jpg","art/pollen_47_4784.jpg","art/pollen_47_4814.jpg","art/pollen_47_4815.jpg","art/pollen_47_4817.jpg","art/pollen_47_4822.jpg","art/pollen_47_4828.jpg","art/pollen_47_4836.jpg","art/pollen_47_4857.jpg","art/pollen_47_4868.jpg","art/pollen_47_4888.jpg","art/pollen_47_4893.jpg","art/pollen_47_4897.jpg","art/pollen_49_4937.jpg","img/character-types-02.png","img/character-types-03.png","img/character-types.png","img/cover.jpg","img/cover.png","img/data-types-overview.png","img/dataframe-types.png","img/datatypes01.png","img/datatypes02.png","img/datatypes03.png","img/datatypes04.png","img/datatypes05.png","img/datatypes06.png","img/datatypes07.png","img/datatypes08.png","img/datatypes09.png","img/datatypes10.png","img/datatypes11.png","img/datatypes12.png","img/datatypes13.png","img/datatypes14.png","img/date-types.png","img/duration-types.png","img/factor-types.png","img/integer-types-01.png","img/integer-types-02.png","img/integer-types-03.png","img/logical-types.png","img/null-types.png","img/numeric-types.png","img/old_cover.jpg","img/raw-types.png","img/visual-convention.png","index_files/anchor-4.2.2/anchor.min.js","index_files/bowser-1.9.3/bowser.min.js","index_files/distill-2.2.21/template.v2.js","index_files/header-attrs-2.11/header-attrs.js","index_files/jquery-3.6.0/jquery-3.6.0.js","index_files/jquery-3.6.0/jquery-3.6.0.min.js","index_files/jquery-3.6.0/jquery-3.6.0.min.map","index_files/popper-2.6.0/popper.min.js","index_files/tippy-6.2.7/tippy-bundle.umd.min.js","index_files/tippy-6.2.7/tippy-light-border.css","index_files/tippy-6.2.7/tippy.css","index_files/tippy-6.2.7/tippy.umd.min.js","index_files/webcomponents-2.0.0/webcomponents.js","magicians.csv"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        return "<p>" + $('#ref-' + ref).html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */



html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    sans-serif;
  --mono-font:       monospace;
  --body-font:       sans-serif;
  --navbar-font:     sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */
</style>
<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */
@import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap');

html {
  /*-- Main font sizes --*/
  --title-size:      40px;
  --body-size:       16px;
  --code-size:       16px;
  --aside-size:      14px;
  --fig-cap-size:    14px;

  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);

  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    'Atkinson Hyperlegible', sans-serif;
  --mono-font:       'Fira Code', monospace;
  --body-font:       'Atkinson Hyperlegible', sans-serif;
  --navbar-font:     'Atkinson Hyperlegible', sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   16px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       black; /* #0F2E3D; */
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       black; /* #0F2E3D; */
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */


/*-- ARTICLE CODE BLOCK --*/
d-article pre {
  background-color: #eeeeee;
  padding: 10px;
  overflow-x: auto !important;
}

d-article div.sourceCode pre{
  overflow-x: auto !important;
}


/*-- INLINE CODE -- */
d-article p code {
  font-size: 14px;
  color: #000000;
  background-color: #eeeeee;
  padding: 3px;
}

/* -- REMOVE THUMBNAIL IMAGES -- */
/*
.posts-list .post-preview .description{
  width: 75%;
}
.posts-list .post-preview .thumbnail {
  width: 0;
  display: none;
}
.posts-list .post-preview img {
  display: none;
}
*/


/* -- ASIDE TAGS -- */
aside {
  padding-block-end: 1rem;
}</style>
<style type="text/css">
/* base style */

/* FONT FAMILIES */

:root {
  --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

body,
.posts-list .post-preview p,
.posts-list .description p {
  font-family: var(--body-font), var(--body-default);
}

h1, h2, h3, h4, h5, h6,
.posts-list .post-preview h2,
.posts-list .description h2 {
  font-family: var(--heading-font), var(--heading-default);
}

d-article div.sourceCode code,
d-article pre code {
  font-family: var(--mono-font), var(--mono-default);
}


/*-- TITLE --*/
d-title h1,
.posts-list > h1 {
  color: var(--title-color, black);
}

d-title h1 {
  font-size: var(--title-size, 50px);
}

/*-- HEADERS --*/
d-article h1,
d-article h2,
d-article h3,
d-article h4,
d-article h5,
d-article h6 {
  color: var(--header-color, rgba(0, 0, 0, 0.8));
}

/*-- BODY --*/
d-article > p,  /* only text inside of <p> tags */
d-article > ul, /* lists */
d-article > ol {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
  font-size: var(--body-size, 1.06rem);
}


/*-- CODE --*/
d-article div.sourceCode code,
d-article pre code {
  font-size: var(--code-size, 14px);
}

/*-- ASIDE --*/
d-article aside {
  font-size: var(--aside-size, 12px);
  color: var(--aside-color, rgba(0, 0, 0, 0.6));
}

/*-- FIGURE CAPTIONS --*/
figure .caption,
figure figcaption,
.figure .caption {
  font-size: var(--fig-cap-size, 13px);
  color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
}

/*-- METADATA --*/
d-byline h3 {
  font-size: var(--heading-size, 0.6rem);
  color: var(--heading-color, rgba(0, 0, 0, 0.5));
}

d-byline {
  font-size: var(--body-size, 0.8rem);
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

d-byline a,
d-article d-byline a {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

/*-- TABLE OF CONTENTS --*/
.d-contents nav h3 {
  font-size: var(--heading-size, 18px);
}

.d-contents nav a {
  font-size: var(--contents-size, 13px);
}

/*-- APPENDIX --*/
d-appendix h3 {
  font-size: var(--heading-size, 15px);
  color: var(--heading-color, rgba(0, 0, 0, 0.65));
}

d-appendix {
  font-size: var(--text-size, 0.8em);
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

d-appendix d-footnote-list a.footnote-backlink {
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

/*-- WEBSITE HEADER + FOOTER --*/
.distill-site-header .title {
  font-size: var(--title-size, 18px);
  font-family: var(--navbar-font), var(--heading-default);
}

.distill-site-header a,
.nav-dropdown .nav-dropbtn {
  font-family: var(--navbar-font), var(--heading-default);
}

.nav-dropdown .nav-dropbtn {
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  font-size: var(--text-size, 15px);
}

.distill-site-header a:hover,
.nav-dropdown:hover .nav-dropbtn {
  color: var(--hover-color, white);
}

.distill-site-header {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer a:hover {
  color: var(--hover-color, white);
}</style>
<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.11/header-attrs.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<!-- plausible -->
<script async defer data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>

<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Data types in Arrow and R","description":"A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um... long","authors":[{"author":"Danielle Navarro","authorURL":"https://djnavarro.net","affiliation":"Voltron Data","affiliationURL":"https://voltrondata.com","orcidID":"0000-0001-7648-6578"}],"publishedDate":"2022-03-04T00:00:00.000+11:00","citationText":"Navarro, 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a class="logo" href="https://djnavarro.net">
<img src="../../image/logo-profile.png" alt="Logo"/>
</a>
<a href="../../index.html" class="title">Notes from a data witch</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../about.html">About</a>
<a href="../../index.xml">RSS</a>
<a href="https://github.com/djnavarro">GitHub</a>
<a href="https://twitter.com/djnavarro">Twitter</a>
<a href="https://djnavarro.net">Homepage</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Data types in Arrow and R</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p>A post describing fundamental data types in R and Apache Arrow, and how data is exchanged between the two systems. It covers conversion of logicals, integers, floats, decimals, strings, date, and times, among other things. It talks about higher level structures like tables, data frames, and so on. For reasons that now escape me, esoteric authors are quoted, and I try to bribe the audience into reading the whole thing by adding artwork. This post is, um long</p>
</div>

<div class="d-byline">
  
  true
  
<br/>2022-03-04
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#regarding-magic">Regarding magic</a></li>
<li><a href="#defining-schemas">Defining Schemas</a></li>
<li><a href="#why-mapping-languages-is-hard">Why mapping languages is hard</a></li>
<li><a href="#a-little-bit-of-big-picture">A little bit of big picture</a>
<ul>
<li><a href="#object-oriented-programming-in-arrow">Object oriented programming in <strong>arrow</strong></a></li>
<li><a href="#table-chunkedarray-and-scalar">Table, ChunkedArray, and Scalar</a></li>
</ul></li>
<li><a href="#logical-types">Logical types</a></li>
<li><a href="#integer-types">Integer types</a>
<ul>
<li><a href="#arrow-eight-types-of-integer">[Arrow] Eight types of integer</a></li>
<li><a href="#r-one-integer-class">[R] One integer class</a></li>
<li><a href="#when-integer-translation-is-easy">When integer translation is easy</a></li>
<li><a href="#when-integer-translation-is-hard">When integer translation is hard</a></li>
</ul></li>
<li><a href="#numeric-types">Numeric types</a>
<ul>
<li><a href="#floating-point-numbers-and-the-desert-of-the-reals">Floating point numbers and the desert of the reals</a></li>
<li><a href="#r-the-numeric-class">[R] The numeric class</a></li>
<li><a href="#arrow-the-float64-type">[Arrow] The float64 type</a></li>
<li><a href="#arrow-the-float32-and-float16-types">[Arrow] The float32 and float16 types</a></li>
<li><a href="#decimal-floating-point-numbers">Decimal floating point numbers?</a></li>
<li><a href="#arrow-the-decimal-fixed-point-types">[Arrow] The decimal fixed-point types</a></li>
</ul></li>
<li><a href="#character-types">Character types</a>
<ul>
<li><a href="#r-the-character-class">[R] The character class</a></li>
<li><a href="#arrow-the-utf8-type">[Arrow] The utf8 type</a></li>
<li><a href="#arrow-the-large_utf8-type">[Arrow] The large_utf8 type</a></li>
</ul></li>
<li><a href="#datetime-types">Date/time types</a>
<ul>
<li><a href="#r-the-date-class">[R] The Date class</a></li>
<li><a href="#r-the-posixct-class">[R] The POSIXct class</a></li>
<li><a href="#r-the-posixlt-class">[R] The POSIXlt class</a></li>
<li><a href="#arrow-the-date32-type">[Arrow] The date32 type</a></li>
<li><a href="#arrow-the-date64-type">[Arrow] The date64 type</a></li>
<li><a href="#arrow-the-timestamp-type">[Arrow] The timestamp type</a></li>
<li><a href="#um-but-what-about-posixlt">Um, but what about POSIXlt?</a></li>
</ul></li>
<li><a href="#duration-types">Duration types</a>
<ul>
<li><a href="#r-the-difftime-class">[R] The difftime class</a></li>
<li><a href="#arrow-the-duration-type">[Arrow] The duration type</a></li>
<li><a href="#r-the-hmshms-class">[R] The hms::hms class</a></li>
<li><a href="#arrow-the-time32-and-time64-types">[Arrow] The time32 and time64 types</a></li>
</ul></li>
<li><a href="#other-types">Other types</a></li>
<li><a href="#the-magic-goes-away">The magic goes away</a></li>
</ul>
</nav>
</div>
<!----

checklist:
- check the "update me" messages in YAML above
- initialise the _renv folder with refinery::renv_new("name of post folder")
- populate the lockfile with refinery::renv_snapshot("name of post folder")
- update the _renv folder from snapshot with refinery::restore("name of post folder")

---->
<!--------------- setup post ----------------->
<!--------------- post ----------------->
<blockquote>
<p>Manuals for translating one language into another can be set up in divergent ways, all compatible with the totality of speech dispositions, yet incompatible with one another <br>    William Van Orman Quine, 1960, <a href="https://en.wikipedia.org/wiki/Word_and_Object">Word and Object</a></p>
</blockquote>
<p><br></p>
<p>At the 2018 useR! conference in Brisbane, Roger Peng gave a fabulous keynote talk on <a href="https://www.youtube.com/watch?v=5033jBHFiHE">teaching R to new users</a> in which he provided an overview of the history of the language and how it is used in the broader community. One thing that stood out to me in his talk  and Ive seen reflected in other data  is that R is unusual as a language because its not designed primarily for programmers. Software engineering practices have now become widespread in the R community, and thats a good thing. Nevertheless, a very large proportion of the R community dont have a traditional computer science background  and thats okay! In fact, given the goals of the language thats a good thing too.</p>
<p>R is a language designed with a practical goal in mind: it is a tool for statistical programming and data analysis. Because of this design focus, R users tend to care most deeply about <em>the tasks that make up their day to day jobs</em>. Few of us care about the <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a> standard for encoding floating point numbers. R users are not typically interested in the <a href="https://en.wikipedia.org/wiki/Endianness">big-endian/little-endian</a> distinction. The purpose of R as a high level statistical programming environment is to abstract away from these things, and to allow users to focus on data cleaning, wrangling, and visualisation. R tries to help you get to your data as easily as possible, build models for your data, report those models reliably, and so on. Because thats the job.</p>
<p>But.</p>
<p>Theres always a but, isnt there?</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-1"></span>
<img src="art/pollen_46_4699.jpg" alt="Art"  />
<p class="caption">
Figure 1: Art
</p>
</div>
</div>
<aside>
<br>All images in this post are my own, including the artwork, and though I havent formally released the art as part of series (and hence not specified a licence for the series as a whole), these specific pieces are covered by the same CC-BY licence that applies to the rest of the post
</aside>
<p><br><br></p>
<p>One of the huge changes in the data science ecosystem in recent years is the change in scale of our data sets. Data sets can now easily encompass billions of rows, and surpass the ability of your machine (and R) to hold in memory. Another huge change in the ecosystem is the proliferation of tools. Data sets have to be passed from one system to another, and when those data sets are large, problems follow. <a href="https://arrow.apache.org/">Apache Arrow</a> solves these problems by providing a multi-language toolbox for data exchange and data analysis. Its a toolbox designed for a big data environment, and a many-language environment. From the perspective of an R user, it supplies the <strong>arrow</strong> package that provides an interface to Apache Arrow, and through that package allows you to have access to all the other magic that Arrow exposes. Its an extremely powerful toolbox but to use it effectively you do need to learn more of those low-level concepts that we as R users like to skim over.</p>
<aside>
In this post I use boldfaced text to denote the names of R packages such as <strong>arrow</strong> and <strong>dplyr</strong>, as well as C++ library such as <strong>libarrow</strong>
</aside>
<p>This post is an attempt to fill that gap for you! Its a long form post, closer to a full length article than a typical blog. My goals in this post are to:</p>
<ul>
<li>Walk you through (some of!) the low level implementation details for basic data types: how R represents an integer or a numeric, or a date/time object, etc</li>
<li>Discuss how and why Arrow and R sometimes make different choices in these details</li>
<li>Show you how the <strong>arrow</strong> package translates between R and Arrow</li>
<li>Include lots of pretty art, because lets face it, this isnt an exciting topic!</li>
</ul>
<p>This post isnt intended to be read in isolation. Its the third part of a series I have been writing on Apache Arrow and R, and it probably works best if youve read the previous two. Ive made every effort to make this post self-contained and self-explanatory, but it does assume youre comfortable in R and have a little bit of knowledge about what the <strong>arrow</strong> package does. If youre not at all familiar with <strong>arrow</strong>, you may find it valuable to read the first post in the series, which is a <a href="https://blog.djnavarro.net/posts/2021-11-19_starting-apache-arrow-in-r/">getting started post</a>, and possibly the second one that talks about the <a href="https://blog.djnavarro.net/posts/2022-01-18_binding-arrow-to-r/">arrow dplyr backend</a>.</p>
<p>Still keen to read? I havent scared you off?</p>
<p>No?</p>
<p>Fabulous! Then read on, my loves!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tibble.tidyverse.org/'>tibble</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/apache/arrow/'>arrow</a></span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p><br></p>
<h2 id="regarding-magic">Regarding magic</h2>
<p>Consider this piece of magic. I have a csv file storing a data set. I import the data set into R using whatever my favourite csv reader function happens to be:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>magicians</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/read_delim_arrow.html'>read_csv_arrow</a></span><span class='op'>(</span><span class='st'>"magicians.csv"</span><span class='op'>)</span>
<span class='va'>magicians</span>
</code></pre>
</div>
<pre><code># A tibble: 65  6
   season episode title                      air_date   rating viewers
    &lt;int&gt;   &lt;int&gt; &lt;chr&gt;                      &lt;date&gt;      &lt;dbl&gt;   &lt;dbl&gt;
 1      1       1 Unauthorized Magic         2015-12-16    0.2    0.92
 2      1       2 The Source of Magic        2016-01-25    0.4    1.11
 3      1       3 Consequences of Advanced  2016-02-01    0.4    0.9 
 4      1       4 The World in the Walls     2016-02-08    0.3    0.75
 5      1       5 Mendings, Major and Minor  2016-02-15    0.3    0.75
 6      1       6 Impractical Applications   2016-02-22    0.3    0.65
 7      1       7 The Mayakovsky Circumstan 2016-02-29    0.3    0.7 
 8      1       8 The Strangled Heart        2016-03-07    0.3    0.67
 9      1       9 The Writing Room           2016-03-14    0.3    0.71
10      1      10 Homecoming                 2016-03-21    0.3    0.78
#  with 55 more rows</code></pre>
</div>
<p>Then I decide to copy the data into Arrow.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> I do that in a very predictable way using the <code>arrow_table()</code> function supplied by the <strong>arrow</strong> package:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>arrowmagicks</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/Table.html'>arrow_table</a></span><span class='op'>(</span><span class='va'>magicians</span><span class='op'>)</span>
<span class='va'>arrowmagicks</span>
</code></pre>
</div>
<pre><code>Table
65 rows x 6 columns
$season &lt;int32&gt;
$episode &lt;int32&gt;
$title &lt;string&gt;
$air_date &lt;date32[day]&gt;
$rating &lt;double&gt;
$viewers &lt;double&gt;</code></pre>
</div>
<p>This is exactly the output I should expect, but the longer I think about it the more it seems to me that something quite remarkable is going on. Some magic is in play here, and I want to know how it works.</p>
<p>To understand why Im so curious, consider the two objects I now have. The <code>magicians</code> data set is a <em>data frame</em> (a <em>tibble</em>, technically) stored in R. The <code>arrowmagicks</code> data set, however, is a pointer to a data structure stored in Arrow. That data structure is a <em>Table</em> object. <em>Table</em> objects in Arrow are roughly analogous to <em>data frames</em>  both represent tabular data with columns that may be of different types  but they are not the same. The columns of a <em>Table</em> are built from objects called <em>ChunkedArrays</em> that are in turn constructed from <em>Arrays</em>, and those <em>Arrays</em> can contain <em>Scalar</em> objects. In other words, to move data from one language to another an act of translation is required, illustrated below:</p>
<aside>
Its not standard, but since this is a post about data types, Ill italicise the names of data types in both R and Arrow (e.g., <i>data.frame</i>, <i>Table</i>). It gets a bit tiresome, but I think its helpful
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-6"></span>
<img src="img/data-types-overview.png" alt="A miniature translation guide. On the left a data frame in R is shown: it is comprised of three columns. Each columns is an R vector. We use the term 'element' to refer to any length-1 constituent of a vector, even though it isn't really a distinct object in its own right. On the right is a Table in Arrow: it too is comprised of three columns, encoded as ChunkedArrays. Each ChunkedArray is comprised of one or more Arrays, and each Array contains one or more Scalars, which (unlike elements of R vectors) are distinct objects. The data structure that translates one into the other is called a Schema." width="2135" />
<p class="caption">
Figure 2: A miniature translation guide. On the left a data frame in R is shown: it is comprised of three columns. Each columns is an R vector. We use the term element to refer to any length-1 constituent of a vector, even though it isnt really a distinct object in its own right. On the right is a Table in Arrow: it too is comprised of three columns, encoded as ChunkedArrays. Each ChunkedArray is comprised of one or more Arrays, and each Array contains one or more Scalars, which (unlike elements of R vectors) are distinct objects. The data structure that translates one into the other is called a Schema.
</p>
</div>
</div>
<p>In this post Im not going to talk much about the difference between <em>Arrays</em> and <em>ChunkedArrays</em>, or why Arrow organises <em>Tables</em> this way (that will be the topic of a later post). For now its enough to recognise that Arrow does have this additional structure: the <em>Table</em> data type in Arrow is not equivalent to the <em>data frame</em> class in R, so a little work is required to map one to the other.</p>
<p>A similar story applies when we look at the contents of the data set. The translation process doesnt just apply to the container object (i.e., the <em>data frame</em> in R and the <em>Table</em> in Arrow), it also applies to the values that the object contains. If we look at the how the columns of <code>magicians</code> and <code>arrowmagicks</code> are labelled, we see evidence of this translation. The <em>integer</em> columns in R have been mapped to <em>int32</em> columns in Arrow, <em>Date</em> columns in R become <em>date32</em> columns in Arrow, and so on.</p>
<aside>
Variable names like <code>arrowmagicks</code> and function calls like <code>arrow_table()</code> are shown in monospace typewriter font
</aside>
<p>Theres quite a lot of complexity to the translation process, yet it all seems to work seamlessly, and it works both ways. I can pull the <code>arrowmagicks</code> data back into R and recover the original data:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://dplyr.tidyverse.org/reference/compute.html'>collect</a></span><span class='op'>(</span><span class='va'>arrowmagicks</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 65  6
   season episode title                      air_date   rating viewers
    &lt;int&gt;   &lt;int&gt; &lt;chr&gt;                      &lt;date&gt;      &lt;dbl&gt;   &lt;dbl&gt;
 1      1       1 Unauthorized Magic         2015-12-16    0.2    0.92
 2      1       2 The Source of Magic        2016-01-25    0.4    1.11
 3      1       3 Consequences of Advanced  2016-02-01    0.4    0.9 
 4      1       4 The World in the Walls     2016-02-08    0.3    0.75
 5      1       5 Mendings, Major and Minor  2016-02-15    0.3    0.75
 6      1       6 Impractical Applications   2016-02-22    0.3    0.65
 7      1       7 The Mayakovsky Circumstan 2016-02-29    0.3    0.7 
 8      1       8 The Strangled Heart        2016-03-07    0.3    0.67
 9      1       9 The Writing Room           2016-03-14    0.3    0.71
10      1      10 Homecoming                 2016-03-21    0.3    0.78
#  with 55 more rows</code></pre>
</div>
<p>In this example the translation back and forth just works. You really dont have to think too much about the subtle differences in how Arrow and R think about the world and how their data structures are organised. And in general thats what we want in a multi-language toolbox: we want the data analyst to be thinking about the data, not the cross-linguistic subtleties of the data structures!</p>
<p>That being said, its also valuable to give the data analyst flexibility. And that means were going to need to talk about <em>Schemas</em>. As shown in the translation diagram above, <em>Schemas</em> are the data structure <strong>arrow</strong> uses to govern the translation between R and Arrow, and since Im going to be talking about data on the R side and data on the Arrow side a lot, it will be helpful to have some visual conventions to make it a little clearer. Throughout the post youll see diagrams showing the default mappings that the <strong>arrow</strong> package uses when converting data columns from R to Arrow and vice versa. In each case Ill show R data types on the left hand side (against a blue background) and Arrow data types on the right hand side (against an orange background), like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-8"></span>
<img src="img/visual-convention.png" alt="Illustration of the graphical convention used in the later   diagrams, showing R on the left side (against a blue background) and Arrow on the right side (against an orange background)." width="960" />
<p class="caption">
Figure 3: Illustration of the graphical convention used in the later diagrams, showing R on the left side (against a blue background) and Arrow on the right side (against an orange background).
</p>
</div>
</div>
<p><br></p>
<h2 id="defining-schemas">Defining Schemas</h2>
<p>The <strong>arrow</strong> package makes very sensible default choices about how to translate an R data structure into an Arrow data structure, but those choices can never be more than defaults because of the fundamental fact that the languages are inherently different. The quote about the <a href="https://en.wikipedia.org/wiki/Indeterminacy_of_translation">indeterminacy of translation</a> at the top of this post was originally written about natural languages, but I think it applies in programming too. Theres no single rulebook that tells you how to translate between R and Arrow: there cant be.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Suppose that I knew that there would in fact be a Season 5.1648 coming, consisting of a single episode that would air not only on a specific date, but at a specific time that would  for some bizarre reason<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>  be important to encode in the data. Knowing that this new data point is coming, Id perhaps want my Arrow data to encode <code>season</code> as a numeric variable, and Id need to encode the <code>air_date</code> field using a date type that implicitly encodes time of day. I can do this with the <code>schema()</code> function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>translation</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/Schema.html'>schema</a></span><span class='op'>(</span>
  season <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>float64</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='co'># not the default</span>
  episode <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int32</a></span><span class='op'>(</span><span class='op'>)</span>,
  title <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>utf8</a></span><span class='op'>(</span><span class='op'>)</span>, 
  air_date <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>date64</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='co'># not the default</span>
  rating <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>float64</a></span><span class='op'>(</span><span class='op'>)</span>,
  viewers <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>float64</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Now I can use my schema to govern the translation:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>arrowmagicks2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/Table.html'>arrow_table</a></span><span class='op'>(</span><span class='va'>magicians</span>, schema <span class='op'>=</span> <span class='va'>translation</span><span class='op'>)</span>
<span class='va'>arrowmagicks2</span>
</code></pre>
</div>
<pre><code>Table
65 rows x 6 columns
$season &lt;double&gt;
$episode &lt;int32&gt;
$title &lt;string&gt;
$air_date &lt;date64[ms]&gt;
$rating &lt;double&gt;
$viewers &lt;double&gt;</code></pre>
</div>
<p>The output may not make complete sense at this point, but hopefull the gist of what Ive done should be clear. The <code>season</code> is no longer stored as an integer (its now a numeric type), and the <code>air_date</code> no longer uses day as the unit of encoding, it uses ms (i.e., millisecond). Ive accomplished my goals. Yay!</p>
<p>This is of course a toy example, as are all the other examples youll encounter in this post. But the underlying issues are important ones!</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-11"></span>
<img src="art/pollen_49_4937.jpg" alt="Art"  />
<p class="caption">
Figure 4: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="why-mapping-languages-is-hard">Why mapping languages is hard</h2>
<!--

> BEASTS, may be distinguished by their several shapes, properties, uses, food, their tameness or wildness, etc. into such as are either
> 
> - VIVIPAROUS; producing living young.
> 
>     - WHOLE FOOTED, the *soles* of whose *feet* is are undivided, being used chiefly for *Carriage*. I.
>     - CLOVEN FOOTED. II. <br>
>       *Clawed*, or *multifidous*; the end of whose *feet* is branched out into *toes*; whether
>       
>         - NOT RAPACIOUS. III.
>         - RAPACIOUS; living upon the prey of other *Animals*; having generally *six short pointed* incisors, or *cutting teeth*, and *two long fangs* to hold their prey; whether the
>         
>             - CAT-KIND; having a *roundish head*. IV.
>             - DOG-KIND; whose *heads* are *more oblong*. V.
>             
> - OVIPAROUS; breeding *Eggs*. VI.
>
> -- John Wilkins, 1668, [An Essay Towards a Real Character, and a Philosophical Language](https://www.google.com.au/books/edition/_/BCCtZjBtiEYC?hl=en&gbpv=1)

-->
<p>Organising the world into concepts (or data structures) is hard.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> We define <a href="https://en.wikipedia.org/wiki/Ontology_(information_science)">ontologies</a> that impose order on a chaotic world, but those structures are rarely adequate to describe the world as it is. While doing background research for this post I spent a little time reading various sections from <a href="https://www.google.com.au/books/edition/_/BCCtZjBtiEYC?hl=en&amp;gbpv=1">An Essay Towards a Real Character, and a Philosophical Language</a>, a monograph written by John Wilkins in 1668 that makes a valiant (but doomed oh so doomed) attempt to organise all the categories of things and propose a mechanism by which we could describe them within a single universal language. The classification systems he came up with were not great. For example, he divided BEASTS into two categories: VIVIPAROUS beasts are those that bear live young, whereas OVIPAROUS beasts are those that lay eggs. The viviparous ones could be subdivided into WHOLE-FOOTED ones and CLOVEN-FOOTED ones. The cloven-footed beasts could be subdivided into those that were RAPACIOUS and those that were not. RAPACIOUS types could be of the CAT-KIND or the DOG-KIND.</p>
<p>Suffice it to say the poor man had never encountered a kangaroo.</p>
<p>The problem with trying to construct universal ontologies is that these things are made by humans, and humans have a perspective that is tied to their own experience and history. As a 17th century English gentleman, Wilkins saw the world in a particular way, and the structure of the language he tried to construct reflected that fact.</p>
<p>I am of course hardly the first person to notice this. In 1952 the Argentinian author Jorge Luis Borges published a wonderful essay called <a href="https://ccrma.stanford.edu/courses/155/assignment/ex1/Borges.pdf">The Analytical Language of John Wilkins</a> that both praises Wilkins ambition and then carefully illustrates why it is necessarily doomed to fail. Borges essay describes a classification system from an fictitious Celestial Emporium of Benevolent Knowledge which carves up the beasts as follows:</p>
<blockquote>
<p>In its remote pages it is written that the animals are divided into: (a) belonging to the emperor, (b) embalmed, (c) tame, (d) sucking pigs, (e) sirens, (f) fabulous, (g) stray dogs, (h) included in the present classification, (i) frenzied, (j) innumerable, (k) drawn with a very fine camelhair brush, (l) et cetera, (m) having just broken the water pitcher, (n) that from a long way off look like flies</p>
</blockquote>
<p>Now, its pretty unlikely that any human language would produce a classification system quite as chaotic as Borges fictional example, but the point is well made. Actual classification systems used in different languages and cultures are very different to one another and often feel very alien when translated. Its a pretty fundamental point, and I think it applies to programming languages too.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Every language carries with it a set of assumptions and structures that it considers natural, and translation across the boundaries between languages is necessarily a tricky business.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<p><br></p>
<h2 id="a-little-bit-of-big-picture">A little bit of big picture</h2>
<p>Before we get to moving data around part its helpful to step back a little and recognise that R and Arrow are designed quite differently. For starters, the <strong>libarrow</strong> library to which the <strong>arrow</strong> package provides bindings is written in C++, and C++ is itself a different kind of language than R. And in a sense, thats actually the natural place to start because it influences a lot of things in the design of <strong>arrow</strong>.</p>
<p><br></p>
<h3 id="object-oriented-programming-in-arrow">Object oriented programming in <strong>arrow</strong></h3>
<p>One of ways in which C++ and R differ is in how each language approaches object oriented programming (OOP). The approach taken in C++ is an <a href="https://adv-r.hadley.nz/oo.html">encapsulated OOP</a> model that is common to many programming languages: methods belong to objects. Anyone coming from outside R is probably most familiar with this style of OOP.</p>
<p>The approach taken in R is chaotic. R has several different OOP systems that have different philosophies, and each system has its own strengths and weaknesses.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> The most commonly used system is S3, which is a <a href="https://adv-r.hadley.nz/oo.html">functional OOP</a> model: methods belong to generic functions like <code>print()</code>. Most R users will be comfortable with S3 because its what we see most often. That being said, there are several other systems out there, some of which adopt the more conventional encapsulated OOP paradigm. One of the most popular ones is <a href="https://r6.r-lib.org/">R6</a>, and it works more like the OOP systems seen in other languages.</p>
<p>The <strong>arrow</strong> package uses both S3 and R6, but it uses them for quite different things. Whenever <strong>arrow</strong> does something in an R-native way, S3 methods get used a lot. For example, in my earlier post on <a href="https://blog.djnavarro.net/posts/2022-01-18_binding-arrow-to-r/">dplyr bindings for Arrow</a> I talked about how <strong>arrow</strong> supplies a <strong>dplyr</strong> engine: this works in part by supplying S3 methods for various <strong>dplyr</strong> functions that are called whenever a suitable Arrow object gets passed to <strong>dplyr</strong>. The interface between <strong>arrow</strong> and <strong>dplyr</strong> uses S3 because this context is R like. However, this isnt a post about that aspect of <strong>arrow</strong>, so we wont need to talk about S3 again in this post.</p>
<p>However, <strong>arrow</strong> has a second task, which is to interact with <strong>libarrow</strong>, the Arrow C++ library. Because the data structures there all use encapsulated OOP as is conventional in C++, it is convenient to adhere to those conventions within the <strong>arrow</strong> package. Whenever <strong>arrow</strong> has to interact with <strong>libarrow</strong>, its useful to be as C++ like as possible, and this in turn means that the interface between <strong>arrow</strong> and <strong>libarrow</strong> is accomplished using R6. So we will be seeing <em>R6</em> objects appear quite often in this post.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p><br></p>
<h3 id="table-chunkedarray-and-scalar">Table, ChunkedArray, and Scalar</h3>
<p>You may be wondering what I mean when I say that <em>R6</em> objects are used to supply the interface between R and Arrow. Ill try to give some concrete examples. Lets think about the <code>arrow_table()</code> function. At the start of the post I used this function to translate an R data frame into an Arrow <em>Table</em>, like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/Table.html'>arrow_table</a></span><span class='op'>(</span><span class='va'>magicians</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>This is a natural way of thinking about things in R, but the <code>arrow_table()</code> function doesnt actually do the work. Its actually just a wrapper function. Within the <strong>arrow</strong> package is an R6 class generator object called <code>Table</code>,<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> and its job is to create tables, modify tables, and so on. You can create a table by using the <code>create()</code> method for <code>Table</code>. In other words, instead of calling <code>arrow_table()</code> I could have done this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Table</span><span class='op'>$</span><span class='fu'>create</span><span class='op'>(</span><span class='va'>magicians</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>and I would have ended up with the same result.</p>
<p>The same pattern appears throughout the <strong>arrow</strong> package. When I used the <code>schema()</code> function earlier, the same pattern was in play. There is an R6 class generator called <code>Schema</code>, and it too has a <code>create()</code> method. I could have accomplished the same thing by calling <code>Schema$create()</code>.</p>
<p>I could go on like this for some time. Though I wont talk about all of them in this post, there are R6 objects for <code>Dataset</code>, <code>RecordBatch</code>, <code>Array</code>, <code>ChunkedArray</code>, <code>Scalar</code>, and more. Each of these provides an interface to a data structure in Arrow, and while you can often solve all your problems without ever interacting with these objects, its very handy to know about them and feel comfortable using them. As the post goes on, youll see me doing that from time to time.</p>
<p>But enough of that! Its time to start moving data around</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-14"></span>
<img src="art/pollen_47_4893.jpg" alt="Art"  />
<p class="caption">
Figure 5: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="logical-types">Logical types</h2>
<p>At long last we arrive at the point where Im talking about the data values themselves, and the simplest kind of data to talk about are those used to represent truth values. In R, these are called <em>logical</em> data and can take on three possible values: <code>TRUE</code> and <code>FALSE</code> are the two truth values, and <code>NA</code> is used to denote missing data.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> In a moment Ill show you how to directly pass individual values from R to Arrow, but for the moment lets stick to what we know and pass the data across as part of a tabular data structure. Heres a tiny <em>tibble</em>, with one column of <em>logical</em> values:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span>, <span class='cn'>NA</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>dat</span>
</code></pre>
</div>
<pre><code># A tibble: 3  1
  values
  &lt;lgl&gt; 
1 TRUE  
2 FALSE 
3 NA    </code></pre>
</div>
<p>Were going to pass this across to Arrow using <code>arrow_table()</code> but before we do lets talk about what we expect to happen when the data arrive at the other side.</p>
<p>In this case, its quite straightforward. Arrow has a <em>boolean</em> type that has truth values <code>true</code> and <code>false</code> that behave the same way as their cousins in R. Just like R, Arrow allows missing values, though theyre called <code>null</code> values in Arrow. Unlike basically every other example were going to see in this post, this one is straightforward because the mapping is perfect. Unless you do something to override it, the <strong>arrow</strong> package will map an R <em>logical</em> to an Arrow <em>boolean</em> and vice versa. Heres the diagram I use to describe it:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-16"></span>
<img src="img/logical-types.png" alt="Default mappings for logical types" width="960" />
<p class="caption">
Figure 6: Default mappings for logical types
</p>
</div>
</div>
<p>Seems to make sense, right? So lets stop talking about it and create the corresponding <em>Table</em> in Arrow:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tbl</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/Table.html'>arrow_table</a></span><span class='op'>(</span><span class='va'>dat</span><span class='op'>)</span>
<span class='va'>tbl</span>
</code></pre>
</div>
<pre><code>Table
3 rows x 1 columns
$values &lt;bool&gt;</code></pre>
</div>
<p>Hm. Okay thats a little underwhelming as output goes? Id like to see the actual values please. Happily the <strong>arrow</strong> package supplies a <code>$</code> operator for <em>Table</em> objects so we can extract an individual column from <code>tbl</code> the same way we can from the original R object <code>dat</code>. Lets try that:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tbl</span><span class='op'>$</span><span class='va'>values</span>
</code></pre>
</div>
<pre><code>ChunkedArray
[
  [
    true,
    false,
    null
  ]
]</code></pre>
</div>
<p>The output looks a little different to what wed get when printing out a single column of a <em>tibble</em> (or <em>data frame</em>), but its pretty clear that weve extracted the right thing. A single column inside an Arrow <em>Table</em> is stored as a <em>ChunkedArray</em>, so this looks right.</p>
<p>Yay us!</p>
<p>At this point, its handy to remember that the <code>arrow_table()</code> function that I used to move the data into Arrow is really just a wrapper that allows you to access some of the <code>Table</code> functionality without having to think about R6 too much. I also mentioned theres a class generator called <code>ChunkedArray</code> object and a <code>chunked_array()</code> wrapper function. In hindsight, I probably didnt need to bother creating the <em>tibble</em> and porting that over as a <em>Table</em>. I could have created a <em>logical vector</em> in R and port that over as a <em>ChunkedArray</em> directly:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>values</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>TRUE</span>, <span class='cn'>FALSE</span>, <span class='cn'>NA</span><span class='op'>)</span>
<span class='fu'><a href='https://arrow.apache.org/docs/r/reference/ChunkedArray.html'>chunked_array</a></span><span class='op'>(</span><span class='va'>values</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>ChunkedArray
[
  [
    true,
    false,
    null
  ]
]</code></pre>
</div>
<p>Thats a cleaner way of doing things. If you want a <em>Table</em>, use <code>Table</code> and its wrappers. If you want a <em>ChunkedArray</em>, use <code>ChunkedArray</code> and its wrappers. Theres no need to over-complicate things.</p>
<p>Speaking of which later in the post, Ill often want to send single values to Arrow. In those cases I dont want to create a <em>ChunkedArray</em>, or even the simpler unchunked <em>Array</em> type. What I want to pass is a <em>Scalar</em>.</p>
<p>Its worth unpacking this a little. Unlike some languages, R doesnt really make a strong distinction between vectors and scalars: an R scalar is just a vector of length one. Arrow is stricter, however. A <em>ChunkedArray</em> is a container object with one or more <em>Arrays</em>, and an <em>Array</em> is also a container object with one or more <em>Scalars</em>. If it helps, you can think of it a little bit like working with <em>lists</em> in R: if I have a list <code>lst</code>, then <code>lst[1]</code> is still a list. It doesnt return the contents of the list. If I want to extract the contents I have to use <code>lst[[1]]</code> to pull them out. Arrow <em>Arrays</em> contain <em>Scalars</em> in a fashion that we would call list-like in R.</p>
<p>In any case, the important thing to recognise is that <strong>arrow</strong> contains a class generator object called <code>Scalar</code>, and it works the same way as the other ones. The one difference is that there arent any wrapper functions for <code>Scalar</code>, so Ill have to use <code>Scalar$create()</code> directly:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Scalar</span><span class='op'>$</span><span class='fu'>create</span><span class='op'>(</span><span class='cn'>TRUE</span>, type <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>boolean</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
true</code></pre>
</div>
<p>In this example I didnt really need to explicitly specify that I wanted to import the data as <code>type = boolean()</code>. The value <code>TRUE</code> is an R <em>logical</em>, and the <strong>arrow</strong> default is to map <em>logicals</em> onto <em>booleans</em>. I only included it here because I wanted to call attention to the <code>type</code> argument. Any time that you want to import data as a non-default type, you need to specify the <code>type</code> argument. If you look at the list of <a href="https://arrow.apache.org/docs/dev/r/reference/data-type.html">Apache Arrow data types</a> on the <strong>arrow</strong> documentation page, youll see quite a lot of options. For now, the key thing to note is that the <code>type</code> argument expects you to call one of these functions.</p>
<p>Anyway, thats everything I had to say about <em>logicals</em>. Before moving on though, Im going to write my own wrapper function, and define <code>scalar()</code> as an alias for <code>Scalar$create()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>scalar</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>type</span> <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>Scalar</span><span class='op'>$</span><span class='fu'>create</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>type</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>The main reason Im doing that is for convenience, because in this post Im actually going to need this wrapper function a lot. So I should probably check does it work?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='cn'>TRUE</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
true</code></pre>
</div>
<p>Awesome!</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-23"></span>
<img src="art/pollen_47_4897.jpg" alt="Art"  />
<p class="caption">
Figure 7: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="integer-types">Integer types</h2>
<p>When translating R logicals to Arrow booleans, there arent a lot of conceptual difficulties. R has one data structure and Arrow has one data structure, and theyre basically identical. This is easy. Integers, however, are a little trickier because theres no longer an exact mapping between the two languages. Base R provides one <em>integer</em> type, but Arrow provides eight distinct integer types that it inherits from C++. As a consequence it will no longer be possible to provide one-to-one mappings between R and Arrow, and some choices have to be made. As well see in this section, the <strong>arrow</strong> package tries very hard to set sensible default choices, and in most cases these will work seamlessly. Its not something you actually have to think about much. But, as my dear friend Dan Simpson<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> reminds me over and over with all things technical, <a href="https://statmodeling.stat.columbia.edu/2022/03/02/god-is-present-in-the-sweeping-gestures-but-the-devil-is-in-the-details/">God is present in the sweeping gestures but the Devil is in the details</a>.</p>
<p>It is wise to look carefully at the details, so lets do that.</p>
<p><br></p>
<h3 id="arrow-eight-types-of-integer">[Arrow] Eight types of integer</h3>
<p>To make sense of the different types, it helps to take a moment to think about how integers are represented in a binary format. Lets suppose we allocate 8 bits to specify an integer. If we do that, then there are <span class="math inline">\(2^8 = 256\)</span> unique binary patterns we can create with these bits. Because of this, there is a fundamental constraint: no matter how we choose to set it up, 8-bit integers can only represent 256 distinct numbers. Technically, we could choose any 256 numbers we like, but in practice there are only two schemes used for 8-bit integers: unsigned 8-bit integers (<em>uint8</em>) use those bits to represent integers from 0 to 255, whereas signed 8-bit integers (<em>int8</em>) can represent integers from -128 to 127.</p>
<p>More generally, an unsigned n-bit integer can represent integers from 0 to <span class="math inline">\(2^n - 1\)</span>, whereas a signed n-bit integer can represent integers from <span class="math inline">\(-2^{n-1}\)</span> to <span class="math inline">\(2^{n-1} - 1\)</span>. Heres what that looks like for all the integer types supported by Arrow:</p>
<table>
<thead>
<tr class="header">
<th>Description</th>
<th style="text-align: right;">Name</th>
<th style="text-align: right;">Smallest Value</th>
<th style="text-align: right;">Largest Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>8 bit unsigned</td>
<td style="text-align: right;"><em>uint8</em></td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">255</td>
</tr>
<tr class="even">
<td>16 bit unsigned</td>
<td style="text-align: right;"><em>uint16</em></td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">65535</td>
</tr>
<tr class="odd">
<td>32 bit unsigned</td>
<td style="text-align: right;"><em>uint32</em></td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4294967295</td>
</tr>
<tr class="even">
<td>64 bit unsigned</td>
<td style="text-align: right;"><em>uint64</em></td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">18446744073709551615</td>
</tr>
<tr class="odd">
<td>8 bit signed</td>
<td style="text-align: right;"><em>int8</em></td>
<td style="text-align: right;">-128</td>
<td style="text-align: right;">127</td>
</tr>
<tr class="even">
<td>16 bit signed</td>
<td style="text-align: right;"><em>int16</em></td>
<td style="text-align: right;">-32768</td>
<td style="text-align: right;">32767</td>
</tr>
<tr class="odd">
<td>32 bit signed</td>
<td style="text-align: right;"><em>int32</em></td>
<td style="text-align: right;">-2147483648</td>
<td style="text-align: right;">2147483647</td>
</tr>
<tr class="even">
<td>64 bit signed</td>
<td style="text-align: right;"><em>int64</em></td>
<td style="text-align: right;">-9223372036854775808</td>
<td style="text-align: right;">9223372036854775807</td>
</tr>
</tbody>
</table>
<p><br></p>
<h3 id="r-one-integer-class">[R] One integer class</h3>
<p>On the R side, the <em>integer</em> type supplied by base R is a 32 bit signed integer, and has a natural one-to-one mapping to the Arrow <em>int32</em> type. Because of this, the <strong>arrow</strong> default is to convert an R <em>integer</em> to an Arrow <em>int32</em> and vice versa. Heres an example. Ive been watching <a href="https://en.wikipedia.org/wiki/Snowpiercer_(TV_series)"><em>Snowpiercer</em></a> lately, and the train is currently 1029 cars long so lets pass the integer <code>1029L</code> from R over to Arrow</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>snowpiercer</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='fl'>1029L</span><span class='op'>)</span>
<span class='va'>snowpiercer</span>
</code></pre>
</div>
<pre><code>Scalar
1029</code></pre>
</div>
<p>Lets inspect the <code>type</code> field of the <code>snowpiercer</code> object in order to determine what type of object has arrived in Arrow:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>snowpiercer</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Int32
int32</code></pre>
</div>
<p>We can apply the S3 generic function <code>as.vector()</code> to <code>snowpiercer</code> to pull the data back into R,<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> and hopefully it comes as no surprise to see that we get the same number back:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='va'>snowpiercer</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 1029</code></pre>
</div>
<p>We can take this one step further to check that the returned object is actually an R <em>integer</em> by checking its <code>class()</code>, and again there are no surprises:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>snowpiercer</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;integer&quot;</code></pre>
</div>
<p>As you can see, the default behaviour in <strong>arrow</strong> is to translate an R <em>integer</em> into an Arrow <em>int32</em>, and vice versa. That part, at least, is not too complicated.</p>
<p>That being said, its worth unpacking some of the mechanics of what Im doing with the code here. Everything Ive shown above is R code, so its important to keep it firmly in mind that when I create the <code>snowpiercer</code> object there are two different things happening: a data object is created inside Arrow, and a pointer to that object is created inside R. The <code>snowpiercer</code> object is that pointer (its actually an <em>R6</em> object). When I called <code>snowpiercer$type</code> in R, the output is telling me that the data object in Arrow has type <em>int32</em>. Theres a division of responsibility between R and Arrow that always needs to be kept in mind.</p>
<p>Now, in this particular example theres an element of silliness because my data object is so tiny. There was never a good reason to put the data in Arrow, and the only reason Im doing it here is for explanatory purposes. But in real life (like in the TV shoe), <code>snowpiercer</code> might in fact be a gargantuan monstrosity over which you have perilously little control due to its staggering size. In that case it makes a big difference where the data object is stored. Placing the data object in Arrow is a little bit like powering your 1029-car long train using the fictitious perpetual motion engine from the show: it is a really, really good idea when you have gargantuan data.<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a></p>
<p><br></p>
<h3 id="when-integer-translation-is-easy">When integer translation is easy</h3>
<p>What about the other seven C++ integer types? This is where it gets a little trickier. The table above illustrates that some integer types are fully contained within others: unsurprisingly, every number representable by <em>int16</em> can also be represented by <em>int32</em>, so we can say that the <em>int16</em> numbers are fully contained by (i.e.are a proper subset of) the <em>int32</em> numbers. Similarly, <em>uint16</em> is contained by <em>uint32</em>. There are many cases where an unsigned type is contained by a signed type: for instance, <em>int32</em> contains all the <em>uint16</em> numbers. However, because the unsigned integers cannot represent negative numbers, the reverse is never true. So we can map out the relationships between the different types like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-28"></span>
<img src="img/integer-types-03.png" alt="Containment relationships between the integer types." width="274" />
<p class="caption">
Figure 8: Containment relationships between the integer types.
</p>
</div>
</div>
<p>Whenever type A contains type B, its possible to transform an object of type B into an object of type A without losing information or requiring any special handling. R <em>integers</em> are 32 bit signed integers, which means its possible to convert Arrow data of types <em>int32</em>, <em>int16</em>, <em>int8</em>, <em>uint16</em>, and <em>uint8</em> to R <em>integers</em> completely painlessly. So for these data types the <strong>arrow</strong> defaults give us this relationship:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-29"></span>
<img src="img/integer-types-01.png" alt="Default mappings for some integer types" width="960" />
<p class="caption">
Figure 9: Default mappings for some integer types
</p>
</div>
</div>
<p>These are the cases where it is easy.</p>
<p><br></p>
<h3 id="when-integer-translation-is-hard">When integer translation is hard</h3>
<p>Other integer types are messier. To keep things nice and simple, what wed like to do is to map the Arrow <em>uint32</em>, <em>uint64</em>, and <em>int64</em> types onto the R <em>integer</em> type. Sometimes thats possible: if all the stored values fall within the range of values representable by R <em>integers</em> (i.e., are between -2147483648 and 2147483647) then we can do this, and thats what <strong>arrow</strong> does by default. However, if there are values that overflow this range, then <strong>arrow</strong> will import the data as a different type. That leads to a rather messy diagram, Im afraid:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-30"></span>
<img src="img/integer-types-02.png" alt="Default mappings for other integer types. The asterisk notation here is intended to indicate that the path **arrow** follows can depend on the data values and other settings." width="960" />
<p class="caption">
Figure 10: Default mappings for other integer types. The asterisk notation here is intended to indicate that the path <strong>arrow</strong> follows can depend on the data values and other settings.
</p>
</div>
</div>
<p>Translations become messy when the boxes in one language dont quite match up to the content expressed in another. Sometimes its just easier to see the system in action, so lets write a little helper function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>translate_integer</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>type</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>fn</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>type</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>
      value <span class='op'>=</span> <span class='va'>value</span>,
      arrow_type <span class='op'>=</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>type</span><span class='op'>)</span><span class='op'>$</span><span class='va'>type</span><span class='op'>$</span><span class='va'>name</span>,
      r_class <span class='op'>=</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>type</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>}</span>
  <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>map2_dfr</a></span><span class='op'>(</span><span class='va'>value</span>, <span class='va'>type</span>, <span class='va'>fn</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>The <code>translate_integer()</code> function takes a <code>value</code> vector and a <code>type</code> list as input, and it returns a tibble that tells you what Arrow type was created from each input, and what R class gets returned when we import that Arrow object back into R. Ill pass the inputs in as <em>doubles</em> originally, but as youll see they always get imported to Arrow as integer types because thats what Im telling <strong>arrow</strong> to do. So lets start with an easy case. The number 10 is unproblematic because its very small, and <strong>arrow</strong> never encounters any problem trying to pull it back as an R <em>integer</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>translate_integer</span><span class='op'>(</span>
  value <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='fl'>10</span>, <span class='fl'>10</span>, <span class='fl'>10</span><span class='op'>)</span>, 
  type <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint8</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint32</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint64</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 4  3
  value arrow_type r_class
  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  
1    10 uint8      integer
2    10 uint32     integer
3    10 uint64     integer
4    10 int64      integer</code></pre>
</div>
<p>Okay, that makes sense. If the numbers <em>can</em> be represented using the R <em>integer</em> class then thats what <strong>arrow</strong> will do. Why make life unnecessarily difficult for the user?</p>
<p>Now lets increase the number to a value that is too big to store as a signed 32-bit integer. This is a value that R cannot represent as an <em>integer</em>, but Arrow can store as a <em>uint32</em>, <em>uint64</em> or <em>int64</em>. What happens when we try to pull that object back into R?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>translate_integer</span><span class='op'>(</span>
  value <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3000000000</span>, <span class='fl'>3000000000</span>, <span class='fl'>3000000000</span><span class='op'>)</span>, 
  type <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint32</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint64</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 3  3
       value arrow_type r_class  
       &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;    
1 3000000000 uint32     numeric  
2 3000000000 uint64     numeric  
3 3000000000 int64      integer64</code></pre>
</div>
<p>The first two rows seem intuitive. In base R, whenever an <em>integer</em> overflows and becomes too large to store, R will coerce it to a <em>double</em>. This is exactly the same behaviour wed observe if the data had never left R at all. The third row, however, might come as a bit of a surprise. It certainly surprised me the first time I encountered it. Until very recently I did not know that R even <em>had</em> an <em>integer64</em> class. This class is supplied by the <strong>bit64</strong> package, and although Im not going to talk about it in any detail here, it provides a mechanism to represent signed 64-bit integers in R. However, the one thing I will mention is the fact that the existence of the <em>integer64</em> class opens up the possibility of forcing <strong>arrow</strong> to always map the <em>integer64</em> class to the <em>int64</em> type and vice versa. If you set</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/options.html'>options</a></span><span class='op'>(</span>arrow.int64_downcast <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>it will change the <strong>arrow</strong> default so that <em>int64</em> types are always returned as <em>integer64</em> classes, even when the values are small enough that the data could have been mapped to a regular R <em>integer</em>. This can be helpful in situations where you need to guarantee type stability when working with <em>int64</em> data. Now that Ive altered the global options, I can repeat my earlier command with the number 10.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>translate_integer</span><span class='op'>(</span>
  value <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='fl'>10</span>, <span class='fl'>10</span>, <span class='fl'>10</span><span class='op'>)</span>, 
  type <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint8</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint32</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>uint64</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 4  3
  value arrow_type r_class  
  &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;    
1    10 uint8      integer  
2    10 uint32     integer  
3    10 uint64     integer  
4    10 int64      integer64</code></pre>
</div>
<p>Notice that the results change for the <em>int64</em> type only. The int64_downcast option pertains only to the <em>int64</em> type, and does not affect the other integer types.</p>
<p>And thats it for integers. Next up well talk about numeric types, but first Ill be a good girl and restore my options to their previous state:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/options.html'>options</a></span><span class='op'>(</span>arrow.int64_downcast <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-37"></span>
<img src="art/pollen_46_4628.jpg" alt="Art"  />
<p class="caption">
Figure 11: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="numeric-types">Numeric types</h2>
<p>In the last section I talked about the rather extensive range of data types that Arrow has to represent integers. Sure, theres a practical benefit to having all these different data types, but at the same time its wild that we even need so many different data structures to represent something so simple. Integers arent complicated things. We learn them as kids even before we go to school, and we get taught the arithmetic rules to operate on them very early in childhood.</p>
<p>The problem, though, is that there are A LOT of integers. Its a tad inconvenient sometimes, but the set of integers is infinite in size,<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> so it doesnt matter how many bits you allocate to your int type, there will always be integers that your machine cannot represent. But this is obvious, so why am I saying it? Mostly to foreshadow that things get worse when we encounter</p>
<p><br></p>
<h3 id="floating-point-numbers-and-the-desert-of-the-reals">Floating point numbers and the desert of the reals</h3>
<blockquote>
<p>To dissimulate is to pretend not to have what one has. To simulate is to feign to have what one doesnt have. One implies a presence, the other an absence. But it is more complicated than that because simulating is not pretending: Whoever fakes an illness can simply stay in bed and make everyone believe he is ill.Whoever simulates an illness produces in himself some of the symptoms (Littr). Therefore, pretending, or dissimulating, leaves the principle of reality intact: the difference is always clear, it is simply masked, whereas simulation threatens the difference between the true and the false, the real and the imaginary. <br>    Jean Baudrillard, 1981, <a href="https://en.wikipedia.org/wiki/Simulacra_and_Simulation">Simulacra and Simulation</a><a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></p>
</blockquote>
<p>The real numbers correspond to our intuitive concept of the continuous number line. Just like the integers, the real line extends infinitely far in both directions, but unlike the integers the reals are continuous: for any two real numbers  no matter how close they are to each other  there is always another real number in between. This, quite frankly, sucks. Because the moment you accept that this is true, something ugly happens. If I accept that there must exist a number between 1.01 and 1.02, which Ill call 1.015, then I have to accept that there is a number between 1.01 and 1.015, which Ill call 1.0075, and then I have to accept that oh shit this is going to go on forever. In other words, the reals have the obnoxious property that there between any two real numbers there are an infinity of other real numbers.<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p>
<p>Try shoving all that into your finite-precision machine.</p>
<p>Stepping away from the mathematics for a moment, most of us already know how programming languages attempt to solve the problem. They use <a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floating point numbers</a> as a crude tool to approximate the real numbers using a finite-precision machine, and it sort of works, as long as you never forget that floating point numbers dont always obey the normal rules of arithmetic. I imagine most people reading this post already know this but for those that dont, Ill show you the most famous example:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>0.1</span> <span class='op'>+</span> <span class='fl'>0.2</span> <span class='op'>==</span> <span class='fl'>0.3</span>
</code></pre>
</div>
<pre><code>[1] FALSE</code></pre>
</div>
<p>This is not a bug in R. It happens because <code>0.1</code>, <code>0.2</code>, and <code>0.3</code> are not real numbers in the mathematical sense. Rather, they are encoded in R as objects of type <em>double</em>, and a <em>double</em> is a 64-bit floating point number that adheres to the <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE 754</a> standard. Its a bit beyond the scope of this post to dig all the way into the IEEE standard, but it does help a lot to have a general sense of how a floating point number (approximately) encodes a real number, so in the next section Im going to take a look under the hood of R <em>doubles</em>. Ill show you how theyre represented as binary objects, and why they misbehave sometimes. Im doing this for two reasons: firstly its just a handy thing to know, but secondly, understanding the misbehaviour of the standard binary floating point number representation used in R helps motivate why Arrow and some other platforms expose other options to the user.</p>
<p><br></p>
<h3 id="r-the-numeric-class">[R] The numeric class</h3>
<p>To give you a better feel for what a <em>double</em> looks like when represented as a set of bits, Ive written a little extractor function called <code>unpack_double()</code> that decomposes the object into its constituent bits and prints it out in a visually helpful way (<a href="https://github.com/djnavarro/distill-blog/blob/master/_posts/2022-03-04_data-types-in-arrow-and-r/unpack_double.R">source code here</a>). In truth, its just a wrapper around the <code>numTobits()</code> function provided by base R, but one that gives slightly prettier output. Armed with this, lets take a look at the format. To start out, Ill do the most boring thing possible and show you the binary representation of <code>0</code> as a floating point number. You will, I imagine, be entirely unshocked to discover that it is in fact a sequence of 64 zeros:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>0 00000000000 0000000000000000000000000000000000000000000000000000 </code></pre>
</div>
<p>Truly amazing.</p>
<p>Really, the only thing that matters here is to notice the spacing. The sequence of 64 bits are divided into three meaningful chunks. The first bit<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> represents the sign: is this a positive number (first bit equals 0) or a negative number (first bit equals 1), where zero is treated as if it were a positive number. The next 11 bits are used to specify an exponent: you can think of these bits as if they describe a signed int11 type, and can be used to store any number between -1022 and 1023.<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> The remaining 53 bits are used to represent the mantissa.<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a></p>
<p>These three components carve up a real number by using this this decomposition:</p>
<p><span class="math display">\[
(\mbox{real number}) = (\mbox{sign}) \times (\mbox{mantissa}) \times 2 ^ {\mbox{(exponent)}}
\]</span> Any real number can be decomposed in this way, so long as you have enough digits to express your mantissa and your exponent. Of course, on a finite precision machine we wont always have enough digits, and this representation doesnt allow us to fit more numbers into the machine: theres a fundamental limit on what you can accomplish with 64 bits. What it can do for you, however, is let you use your limited resources wisely. The neat thing about adopting the decomposed format that floating-point relies on is that we can describe very large magnitudes and very small magnitudes with a fixed-length mantissa.</p>
<p>To give a concrete example of how floating point works, lets take a look at the internal representation of <code>-9.832</code>, which I am told is the approximate rate of acceleration experienced by a falling object in the Earths polar regions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>polar_g</span> <span class='op'>&lt;-</span> <span class='fu'>unpack_double</span><span class='op'>(</span><span class='op'>-</span><span class='fl'>9.832</span><span class='op'>)</span>
<span class='va'>polar_g</span>
</code></pre>
</div>
<pre><code>1 10000000010 0011101010011111101111100111011011001000101101000100 </code></pre>
</div>
<p>I wrote some extractor functions that convert those binary components to the sign, exponent, and mantissa values that they represent, so lets take a look at those:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>extract_sign</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>
<span class='fu'>extract_exponent</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>
<span class='fu'>extract_mantissa</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] -1
[1] 3
[1] 1.229</code></pre>
</div>
<p>Notice that the sign is always represented exactly: it can only be -1 or 1. The exponent is also represented exactly, as long as its not too large or too small: the number is always an integer value between -1022 and 1023. The mantissa, however, is a fractional value. When you encounter floating point errors its generally going to be because the stored mantissa doesnt represent the true mantissa with sufficient precision.<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a> In any case, lets check that the formula works:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sign</span> <span class='op'>&lt;-</span> <span class='fu'>extract_sign</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>
<span class='va'>exponent</span> <span class='op'>&lt;-</span> <span class='fu'>extract_exponent</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>
<span class='va'>mantissa</span> <span class='op'>&lt;-</span> <span class='fu'>extract_mantissa</span><span class='op'>(</span><span class='va'>polar_g</span><span class='op'>)</span>

<span class='va'>sign</span> <span class='op'>*</span> <span class='va'>mantissa</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>^</span> <span class='va'>exponent</span>
</code></pre>
</div>
<pre><code>[1] -9.832</code></pre>
</div>
<p>Yay!</p>
<p>Just to prove to you that this isnt a fluke, I also included a <code>repack_double()</code> function that automates this calculation. It takes the deconstructed representation of an R <em>double</em> and packs it up again, so <code>repack_double(unpack_double(x))</code> should return <code>x</code>. Here are a few examples:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sanity_check</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>x</span> <span class='op'>==</span> <span class='fu'>repack_double</span><span class='op'>(</span><span class='fu'>unpack_double</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
<span class='fu'>sanity_check</span><span class='op'>(</span><span class='fl'>12</span><span class='op'>)</span>
<span class='fu'>sanity_check</span><span class='op'>(</span><span class='fl'>1345234623462342</span><span class='op'>)</span>
<span class='fu'>sanity_check</span><span class='op'>(</span><span class='fl'>0.000000002345345234523</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] TRUE
[1] TRUE
[1] TRUE</code></pre>
</div>
<p>Now that we have some deeper knowledge of how R <em>doubles</em> are represented internally, lets return to the numbers in the famous example of floating point numbers misbehaving:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.1</span><span class='op'>)</span>
<span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.2</span><span class='op'>)</span>
<span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.3</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>0 01111111011 1001100110011001100110011001100110011001100110011010 
0 01111111100 1001100110011001100110011001100110011001100110011010 
0 01111111101 0011001100110011001100110011001100110011001100110011 </code></pre>
</div>
<p>Although these are clean numbers with a very simple decimal expansion, they are not at all simple when written in a binary floating point representation. In particular, notice that <code>0.1</code> and <code>0.2</code> share the same mantissa but <code>0.3</code> has a different mantissa, and thats where the truncation errors occur. Lets take a peek at <code>0.6</code> and <code>0.9</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.6</span><span class='op'>)</span>
<span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.8</span><span class='op'>)</span>
<span class='fu'>unpack_double</span><span class='op'>(</span><span class='fl'>.9</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>0 01111111110 0011001100110011001100110011001100110011001100110011 
0 01111111110 1001100110011001100110011001100110011001100110011010 
0 01111111110 1100110011001100110011001100110011001100110011001101 </code></pre>
</div>
<p>So it turns out that <code>0.6</code> has the same mantissa as <code>0.3</code>, and <code>0.8</code> has the same mantissa as <code>0.1</code> and <code>0.2</code>, but <code>0.9</code> has a different mantissa from all of them. So what we might expect is that floating point errors can happen for these cases:<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>0.1</span> <span class='op'>+</span> <span class='fl'>0.2</span> <span class='op'>==</span> <span class='fl'>0.3</span>
<span class='fl'>0.3</span> <span class='op'>+</span> <span class='fl'>0.6</span> <span class='op'>==</span> <span class='fl'>0.9</span>
</code></pre>
</div>
<pre><code>[1] FALSE
[1] FALSE</code></pre>
</div>
<p>but not these ones:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>0.1</span> <span class='op'>+</span> <span class='fl'>0.1</span> <span class='op'>==</span> <span class='fl'>0.2</span>
<span class='fl'>0.3</span> <span class='op'>+</span> <span class='fl'>0.3</span> <span class='op'>==</span> <span class='fl'>0.6</span>
<span class='fl'>0.2</span> <span class='op'>+</span> <span class='fl'>0.6</span> <span class='op'>==</span> <span class='fl'>0.8</span>
</code></pre>
</div>
<pre><code>[1] TRUE
[1] TRUE
[1] TRUE</code></pre>
</div>
<p>Okay that checks out! Now, its important to recognise that these errors are very small. So when I say that floating point arithmetic doesnt actually work, a little care is needed. It does am impressively good job of approximating something very complicated using a quite limited tool:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>0.1</span> <span class='op'>+</span> <span class='fl'>0.2</span> <span class='op'>-</span> <span class='fl'>0.3</span>
</code></pre>
</div>
<pre><code>[1] 5.551115e-17</code></pre>
</div>
<p>Ultimately, floating point numbers are a simulation in the sense described by Baudrillard at the start of this section. They are a pretense, an attempt to act as if we can encode a thing (the reals) that we cannot encode. Floating point numbers are a fiction, but they are an extraordinarily useful one because they allow us to cover a very wide span of numbers across the real line, at a pretty high level of precision, without using too much memory.</p>
<p>We pretend that machines can do arithmetic on the reals. They cant, but its a very powerful lie.</p>
<p><br></p>
<h3 id="arrow-the-float64-type">[Arrow] The float64 type</h3>
<p>Okay. That was terribly long-winded, and I do apologise. Nevertheless, I promise there is a point to this story and its time we switched back over to the Arrow side of things to think about what happens there.</p>
<p>By now youre probably getting used to the fact that Arrow tends to have more primitive types than R in most situations. Floating point numbers are no exception. R has only a single class, usually referred to as <em>numeric</em> but sometimes called <em>double</em>. In contrast, Arrow has three: <em>float64</em>, <em>float32</em> and <em>float16</em>.<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a> It also has another numeric type called <em>decimal</em> that Ill discuss later.</p>
<p>The easiest of these to discuss is <em>float64</em>, because it adopts the same conventions as the R <em>double</em> class. Just like R, it uses 64 bits to represent a floating point number.<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> Because the data structures are so similar, the default behaviour in <strong>arrow</strong> is to translate an R <em>double</em> into an Arrow <em>float64</em> and vice versa.</p>
<p>As always, Ive got a little diagram summarising all the default mappings:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-49"></span>
<img src="img/numeric-types.png" alt="Default mappings for numeric types" width="960" />
<p class="caption">
Figure 12: Default mappings for numeric types
</p>
</div>
</div>
<p>Lets have a look at the Arrow <em>float64</em> type. Its a little anticlimactic in a sense, because its the same data structure as the R <em>double</em> type, so all were going to learn is that it behaves the same way! First, lets create one:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float_01</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='fl'>0.1</span><span class='op'>)</span>
<span class='va'>float_01</span>
</code></pre>
</div>
<pre><code>Scalar
0.1</code></pre>
</div>
<p>As always, well verify that the created object has the type were expecting</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float_01</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Float64
double</code></pre>
</div>
<p> and it does, but you might be slightly puzzled by the output this time. Whats going on with the top line and the bottom line? Why does one say Float64 and the other say double?</p>
<p>Weve seen the two lines of output pattern earlier in the post when printing out an <em>int32</em>, but last time the two lines both said the same thing so I didnt bother to comment on it. This time, however, theres something to unpack. The distinction here refers to the name of the object type at the R level and and the C++ level. The first line of the output reads Float64 because thats what this data structure is called at the R level (i.e., according to <strong>arrow</strong>). The second line reads double because thats what this data structure is called at the C++ level (i.e., in <strong>libarrow</strong>). There are a few cases where the <strong>arrow</strong> package adopts a slightly different naming scheme to <strong>libarrow</strong>, and so youll see this happen from time to time later in the post. There are some good reasons for this difference in nomenclature, and its nothing to be concerned about!</p>
<p>Anyway, getting back to the main thread since weve created the value <code>0.1</code> as a <em>float64</em> in Arrow, lets go through the same exercise we did in R and show that Arrow floats produce the same floating point errors. Well create new variables for <code>0.2</code> and <code>0.3</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float_02</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='fl'>0.2</span><span class='op'>)</span>
<span class='va'>float_03</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='fl'>0.3</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Just like we saw in R, the logical test of equality gives a counterintuitive answer:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float_01</span> <span class='op'>+</span> <span class='va'>float_02</span> <span class='op'>==</span> <span class='va'>float_03</span>
</code></pre>
</div>
<pre><code>Scalar
false</code></pre>
</div>
<p> and just like we saw in R, the reason for it is that theres a very small rounding error:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float_01</span> <span class='op'>+</span> <span class='va'>float_02</span> <span class='op'>-</span> <span class='va'>float_03</span>
</code></pre>
</div>
<pre><code>Scalar
5.551115123125783e-17</code></pre>
</div>
<p>Just so you dont have to scroll up to check, yes, the rounding error is the same as the one that R produces:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>0.1</span> <span class='op'>+</span> <span class='fl'>0.2</span> <span class='op'>-</span> <span class='fl'>0.3</span>
</code></pre>
</div>
<pre><code>[1] 5.551115e-17</code></pre>
</div>
<p>R and Arrow implement the same standard for floating point arithmetic, and so they fail in the same way because the failure occurs at the level of the standard. But we dont blame IEEE 754 for that, because its literally impossible to define any standard that will encode the real numbers in an error-free way on a finite-precision machine.</p>
<p><br></p>
<h3 id="arrow-the-float32-and-float16-types">[Arrow] The float32 and float16 types</h3>
<p>The <em>float64</em> type provides an excellent, high precision floating point representation of numeric data. As data types go it is a good type. However, it is a 64-bit type, and sometimes you dont need to store your data at a high degree of precision. With that in mind, because Arrow places a strong emphasis on both scalability and efficiency, it also provides the <em>float32</em> type and the <em>float16</em> type (though <em>float16</em> hasnt really been implemented yet, as far as I know). Encoding numeric data in these formats will save space, but will come at a cost of precision. As always, the decision of what encoding works best for your application will depend on what your needs are.</p>
<p>As far as the <strong>arrow</strong> package is concerned, there are no difficulties in passing data back and forth between R <em>doubles</em> and Arrow <em>float32</em> types, but at present its not really possible to do this with <em>float16</em> because this isnt implemented. Still, we can briefly take a look at how it works for <em>float32</em>. Heres an example of me passing an R <em>double</em> to Arrow:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float32_01</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='fl'>.1</span>, type <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>float32</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>float32_01</span>
</code></pre>
</div>
<pre><code>Scalar
0.1</code></pre>
</div>
<p>Lets quickly verify that it is in fact a 32-bit float:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>float32_01</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Float32
float</code></pre>
</div>
<p>And now lets pull it back into R where it will be, once again, encoded as a <em>double</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='va'>float32_01</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 0.1</code></pre>
</div>
<p>Yay! It works!</p>
<p><br></p>
<h3 id="decimal-floating-point-numbers">Decimal floating point numbers?</h3>
<p>Its time to talk about decimals. This is a fun topic, but I need to start with a warning: I mentioned that Arrow has a <em>decimal</em> type, and your first instinct as an R programmer might be to assume that this is another variation of floating point numbers. Fight this instinct: its not quite right.</p>
<p>Okay, ready?</p>
<p>Earlier in this section I promised that the Baudrillard quote from <em>Simulacra and Simulation</em> was going to be relevant? Well, that time has arrived. Its also the moment at which the quote from <em>Word and Object</em> by Quine that opened this blog post becomes painfully relevant. Stripped of their fancy language, heres what the two authors are telling us in these passages:</p>
<ul>
<li>The Baudrillard quote emphasises that floating point numbers are a simulation. They are the mechanism by which we pretend to encode real numbers on computers. Its a lie, but its a powerful lie that almost works.</li>
<li>The Quine quote emphasises that translation (and, I would argue, simulation also) is underdetermined. For any complicated thing there are many ways to simulate, or translate, or approximate it. These approximations can be extremely accurate and still be inconsistent with each other.</li>
</ul>
<p>Quines truism applies to floating point numbers, and it is the reason why decimal floating point numbers exist in addition binary floating point numbers. All floating point systems are simulations in the Baudrillard sense of the term: lies, strictly speaking, but close enough to true that the distinction between lies and truth gets a little blurry.</p>
<p>Lets see how that plays out with floating point numbers. When discussing doubles in R, I mentioned that they represent the real numbers using a decomposition that looks like this:</p>
<p><span class="math display">\[
(\mbox{real number}) = (\mbox{sign}) \times (\mbox{mantissa}) \times 2 ^ {\mbox{(exponent)}}
\]</span></p>
<p>The number 2 pops out here, doesnt it? Is there any reason to think that 2 is a pre-ordained necessity when approximating the real numbers on a finite-precision machine? Programmers have a tendency to like using 2 as the base unit for everything because it lines up nicely with binary representations, and thats often a good instinct when dealing with machines.</p>
<p>Unfortunately, life consists of more than machines.</p>
<p>In particular, binary representations create problems for floating point arithmetic because the world contains entities known as humans, who have a habit of writing numbers in decimal notation<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a>. Numbers that look simple in decimal notation often look complicated in binary notation and vice versa. As we saw earlier, a simple decimal number like 0.1 doesnt have a short binary expansion and so cannot be represented cleanly in a finite-precision binary floating point number system. Rounding errors are introduced every time a machine uses (base 2) floating point to encode data that were originally stored as a (base 10) number in human text.</p>
<p>A natural solution to this is to design floating point data types that use other bases. It is entirely possible to adopt <a href="https://en.wikipedia.org/wiki/Decimal_floating_point">decimal floating point</a> types that are essentially equivalent to the more familiar binary floating point numbers, but they rely on a base 10 decomposition:</p>
<p><span class="math display">\[
(\mbox{real number}) = (\mbox{sign}) \times (\mbox{mantissa}) \times 10 ^ {\mbox{(exponent)}}
\]</span></p>
<p>The virtues of decimal floating point seem enticing, and its tempting to think that this must be what Arrow implements. However, as well see in the next section, thats not true.</p>
<p>Instead of using floating-point decimals, it supplies fixed-point decimal types. In a floating-point representation, the exponent is chosen automatically, and it is a property of the value itself. The number <code>-9.832</code> will always have an exponent of 3 when encoded as a binary floating-point number (as we saw in the <code>polar_g</code> example earlier), and that exponent will never be influenced by the values of other numbers stored in the same data set.</p>
<p>A fixed-point representation is different. The exponent  and in a decimal representation, remember that the exponent is just the location of the decimal point  is chosen by the user. You have to specify where the decimal point is located manually, and this location will be applied to each value stored in the object. In other words, the exponent  which is now called the scale, and is parameterised slightly differently  becomes a property of the type, not the value.</p>
<p>Sigh. Nothing in life is simple, is it? Itll become a little clearer in the next section, I promise!</p>
<p><br></p>
<h3 id="arrow-the-decimal-fixed-point-types">[Arrow] The decimal fixed-point types</h3>
<p>Arrow has two decimal types, a <em>decimal128</em> type that (shockingly) uses 128 bits to store a floating point decimal number, and a <em>decimal256</em> type that uses 256 bits. As usual <strong>arrow</strong> package supplies type functions <code>decimal128()</code> and <code>decimal256()</code> that allow you to specify decimal types. Both functions have two arguments that you must supply:</p>
<ul>
<li><p><code>precision</code> specifies the number of significant digits to store, similar to setting the length of the mantissa in a floating-point representation.</p></li>
<li><p><code>scale</code> specifies the number of digits that should be stored after the decimal point. If you set <code>scale = 2</code>, exactly two digits will be stored after the decimal point. If you set <code>scale = 0</code>, values will be rounded to the nearest whole number. Negative scales are also permitted (handy when dealing with extremely large numbers), so <code>scale = -2</code> stores the value to the nearest 100.</p></li>
</ul>
<p>One convenience that exists both in the <strong>arrow</strong> R package and within <strong>libarrow</strong> itself is that it can automatically decide whether you need a <em>decimal128</em> or a <em>decimal256</em> simply by looking at the value of the <code>precision</code> argument. If the <code>precision</code> is 38 or less, you can encode the data with a <em>decimal128</em> type. Larger values require a <em>decimal256</em>. If you would like to take advantage of this  as I will do in this post  you can use the <code>decimal()</code> type function which will automatically create the appropriate type based on the specified precision.</p>
<p>One inconvenience that I have in this post, however, is that R doesnt have any analog of a fixed-point <em>decimal</em>, and consequently I dont have any way to create an R decimal that I can then import into Arrow. What Ill do instead is create a floating point array in Arrow, and then explicitly cast it to a <em>decimal</em> type. Step one, create the floating point numbers in Arrow:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>floats</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/ChunkedArray.html'>chunked_array</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.01</span>, <span class='fl'>.1</span>, <span class='fl'>1</span>, <span class='fl'>10</span>, <span class='fl'>100</span><span class='op'>)</span>, type <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>float32</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>floats</span>
</code></pre>
</div>
<pre><code>ChunkedArray
[
  [
    0.01,
    0.1,
    1,
    10,
    100
  ]
]</code></pre>
</div>
<p>Step two, cast the <em>float32</em> numbers to <em>decimals</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>decimals</span> <span class='op'>&lt;-</span> <span class='va'>floats</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>decimal</a></span><span class='op'>(</span>precision <span class='op'>=</span> <span class='fl'>5</span>, scale <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>decimals</span>
</code></pre>
</div>
<pre><code>ChunkedArray
[
  [
    0.01,
    0.10,
    1.00,
    10.00,
    100.00
  ]
]</code></pre>
</div>
<p>These two arrays look almost the same (especially because I chose the <code>scale</code> judiciously!), but the underlying encoding is different. The original <code>floats</code> array is a familiar <em>float32</em> type, but if we have a look at the <code>decimals</code> object we see that it adopts a quite different encoding:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>decimals</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Decimal128Type
decimal128(5, 2)</code></pre>
</div>
<p>To illustrate that these do behave differently, lets have fun making floating point numbers misbehave again:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sad_floats</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/ChunkedArray.html'>chunked_array</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.1</span>, <span class='fl'>.2</span>, <span class='fl'>.3</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>sad_floats</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
0.6000000000000001</code></pre>
</div>
<p>Oh noes. Okay, lets take a sad <em>float32</em> and turn it into a happy <em>decimal</em>. Ill store it as a high precision decimal to make it a little easier to compare the results:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>happy_decimals</span> <span class='op'>&lt;-</span> <span class='va'>sad_floats</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>decimal</a></span><span class='op'>(</span><span class='fl'>20</span>, <span class='fl'>16</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Now lets look at the two sums side by side:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>sad_floats</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>happy_decimals</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
0.6000000000000001
Scalar
0.6000000000000000</code></pre>
</div>
<p>Yay!</p>
<p>As a final note before moving on, it is (of course!!!) the case that fixed-point decimals arent a universal solution to the problems of binary floating-point numbers. They have limitations of their own and there are good reasons why floats remain the default numeric type in most languages. But they have their uses: binary and decimal systems provide different ways to simulate the reals, as do fixed and floating point systems. Each such system is a lie, of course: the reals are too big to be captured in any finite system we create. They are, however, useful.</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-65"></span>
<img src="art/pollen_47_4857.jpg" alt="Art"  />
<p class="caption">
Figure 13: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="character-types">Character types</h2>
<p>Our journey continues. We now leave behind the world of number and enter the domain of text. Such times we shall have! What sights we shall see! (And what terrors lie within?)</p>
<p>Strings are an interesting case. R uses a single data type to represent strings (<em>character</em> vectors) but Arrow has two types, known as <em>strings</em> and <em>large_strings</em>. When using the <strong>arrow</strong> package, Arrow strings are specified using the <code>utf8()</code> function, and large strings correspond to the <code>large_utf8()</code> type. The default mapping is to assume that an R character vector maps onto the Arrow <code>utf8()</code> type, as shown below:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-66"></span>
<img src="img/character-types.png" alt="Default mappings for character types" width="960" />
<p class="caption">
Figure 14: Default mappings for character types
</p>
</div>
</div>
<p>Theres a little more than meets the eye here though, and you might be wondering about the difference between <em>strings</em> and <em>large_strings</em> in Arrow, and when you might prefer one to the other. As you might expect, the large string type is suitable when youre storing large amounts of text, but to understand it properly I need to talk in more depth about how R and Arrow store strings, and Ill use this partial list of people that  according to the lyrics of <a href="https://genius.com/Tism-jung-talent-time-lyrics">Jung Talent Time</a> by TISM  were perhaps granted slightly more fame than they had earned on merit:</p>
<pre><code>Bert Newton
Billy Ray Cyrus
Warwick Capper
Uri Geller
Samantha Fox</code></pre>
<p><br></p>
<h3 id="r-the-character-class">[R] The character class</h3>
<p>Suppose I want to store this as a <em>character</em> vector in R, storing only the family names for the sake of brevity and visual clarity.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>jung_talent</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Newton"</span>, <span class='st'>"Cyrus"</span>, <span class='st'>"Capper"</span>, <span class='st'>"Geller"</span>, <span class='st'>"Fox"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Each element of the <code>jung_talent</code> vector is a variable-length string, and is stored internally by R as an array of individual characters<a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a> So, to a first approximation, your mental model of how R stores the <code>jung_talent</code> variable might look something like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-68"></span>
<img src="img/character-types-02.png" alt="Simplified representation of how character vectors are represented in R" width="2400" />
<p class="caption">
Figure 15: Simplified representation of how character vectors are represented in R
</p>
</div>
</div>
<p>Here, the <code>jung_talent</code> variable is an object<a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a> that contains five elements shown as the orange boxes. Internally, each of those orange boxes is itself an array of individual characters shown as the purple boxes. As a description of what R actually does this is a bit of an oversimplification because it ignores the <a href="https://adv-r.hadley.nz/names-values.html#character-vectors">global string pool</a>, but it will be sufficient for the current purposes.</p>
<p>The key thing to understand conceptually is that R treats the elements of a <em>character</em> vector as the fundamental unit. The <code>jung_talent</code> vector is constructed from five distinct strings, <code>"Newton"</code>, <code>"Cyrus"</code>, etc. The <code>"Newton"</code> string is assigned to position 1, the <code>"Cyrus"</code> string is assigned to position 2, and so on.</p>
<p><br></p>
<h3 id="arrow-the-utf8-type">[Arrow] The utf8 type</h3>
<p>The approach taken in Arrow is rather different. Instead of carving up the character vector into strings (and internally treating the strings as character arrays), it concatenates everything into one long buffer. The text itself is dumped into one long string, like this:</p>
<pre><code>NewtonCyrusCapperGellerFox</code></pre>
<p>The first element of this buffer  the letter <code>"N"</code>  is stored at offset 0 (indexing in Arrow starts at 0), the second element is stored at offset 1, and so on. This long array of text is referred to as the data buffer, and it does not specify where the boundaries between array elements are. Those are stored separately. If I were to create an Arrow string array called <code>jung_talent_arrow</code>, it would be comprised of a data buffer, and an offset buffer that specifies the positions at which each element of the string array begins. In other words, wed have a mental model that looks a bit like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-69"></span>
<img src="img/character-types-03.png" alt="Simplified representation of how character vectors are represented in Arrow" width="1331" />
<p class="caption">
Figure 16: Simplified representation of how character vectors are represented in Arrow
</p>
</div>
</div>
<p>How are each of these buffers encoded?</p>
<ul>
<li><p>The contents of the data buffer are stored as UTF-8 text, which is itself a variable length encoding: some characters are encoded using only 8 bits while others require 32 bits. This <a href="https://deliciousbrains.com/how-unicode-works/">blog post on unicode</a> is a nice explainer.</p></li>
<li><p>The contents of the offset buffer are stored as unsigned integers, either 32 bit or 64 bit, depending on which of the two Arrow string array types youre using. Ill unpack this in the next section.</p></li>
</ul>
<p>Sheesh. That was long. Lets give ourselves a small round of applause for surviving, and now actually DO something. Well port the <code>jung_talent</code> vector over to Arrow.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>jung_talent_arrow</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/ChunkedArray.html'>chunked_array</a></span><span class='op'>(</span><span class='va'>jung_talent</span><span class='op'>)</span>
<span class='va'>jung_talent_arrow</span>
</code></pre>
</div>
<pre><code>ChunkedArray
[
  [
    &quot;Newton&quot;,
    &quot;Cyrus&quot;,
    &quot;Capper&quot;,
    &quot;Geller&quot;,
    &quot;Fox&quot;
  ]
]</code></pre>
</div>
<p>That certainly looks like text to me! Lets take a look at the data type:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>jung_talent_arrow</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Utf8
string</code></pre>
</div>
<p>Yep. Definitely text!</p>
<p><br></p>
<h3 id="arrow-the-large_utf8-type">[Arrow] The large_utf8 type</h3>
<p>Okay, so as I mentioned, Arrow has two different string types: it has <em>strings</em> (also called <em>utf8</em>) and <em>large_strings</em> (also called <em>large_utf8</em>).<a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a> The default in <strong>arrow</strong> is to translate <em>character</em> data in R to the <em>utf8</em> data type in Arrow, but we can override this if we want to. In order to help you make an informed choice, Ill dig a little deeper into the difference between the two types.</p>
<p>The first thing to recognise is that the nature of the data buffer is the same for <em>utf8</em> and <em>large_utf8</em>: the difference between the two lies in how the offset buffers are encoded. When character data are encoded as <em>utf8</em> type, every offset value is stored as an unsigned 32-bit integer. That means that  as shown in the table of integer types earlier in the post  you cannot store an offset value larger than 4294967295. This constrain places a practical cap on the total length of the data buffer: if total amount of text stored in the data buffer is greater than about 2GiB, the offset buffer cant encode the locations within it! Switching to <em>large_utf8</em> means that the offset buffer will store every offset value as an unsigned 64-bit integer. This means that the offset buffer now takes up twice as much space, but it allows you to encode offset values up to um 18446744073709551615. And if youve got so much text that your data buffer is going to exceed that limit, well, frankly you have bigger problems.</p>
<p>In short, if youre not going to exceed 2GiB of text in your array, you dont need <em>large_utf8</em>. Once you start getting near that limit, you might want to think about switching:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>jung_talent_arrow_big</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/ChunkedArray.html'>chunked_array</a></span><span class='op'>(</span><span class='va'>jung_talent</span>, type <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>large_utf8</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>jung_talent_arrow_big</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>LargeUtf8
large_string</code></pre>
</div>
<p>Before moving on, Ill mention one additional complexity. This is a situation where the distinction between <em>Arrays</em> and <em>ChunkedArrays</em> begins to matter. Strictly speaking, I lied earlier when I said theres only one data buffer. A more precise statement would be to say that there is one data buffer per chunk (where each chunk in a <em>ChunkedArray</em> is an <em>Array</em>). <em>ChunkedArrays</em> are designed to allow a block (or chunk) of contiguous rows in a table to be stored together in a single location (or file). There are good reasons for doing that<a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a>, but they arent immediately relevant. What matters is to recognise that in a <em>ChunkedArray</em>, the 2GiB limit on <em>utf8</em> type data applies on a per-chunk basis. The net result of this is that you probably dont need <em>large_utf8</em> except in very specific cases.</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-73"></span>
<img src="art/pollen_47_4828.jpg" alt="Art"  />
<p class="caption">
Figure 17: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="datetime-types">Date/time types</h2>
<p>Next up on our tour of data types are dates and times. Internally, R and Arrow both adopt the convention of measuring time in terms of the time elapsed since a specific moment in time known as the <a href="https://en.wikipedia.org/wiki/Unix_time">unix epoch</a>. The unix epoch is the time 00:00:00 UTC on 1 January 1970. It was a Thursday.</p>
<p>Despite agreeing on fundamentals, there are some oddities in the particulars. Base R has three date/time classes (<em>Date</em>, <em>POSIXct</em>, and <em>POSIXlt</em>), and while Arrow also has three date/time classes (<em>date32</em>, <em>date64</em>, and <em>timestamp</em>), the default mappings between them are a little puzzling unless you are deeply familiar with what all these data types are and what they represent. Ill do the deep dive in a moment, but to give you the big picture heres how the mapping works:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-74"></span>
<img src="img/date-types.png" alt="Default mappings for date/time types" width="960" />
<p class="caption">
Figure 18: Default mappings for date/time types
</p>
</div>
</div>
<p><br></p>
<h3 id="r-the-date-class">[R] The Date class</h3>
<p>On the R side of things, a <em>Date</em> object is represented internally as a numeric value, counting the number of days since the unix epoch. Here is today as a <em>Date</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>today</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.Date</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>today</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08&quot;</code></pre>
</div>
<p>If I use <code>unclass()</code> to see what it looks like under the hood:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>today</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 19059</code></pre>
</div>
<p>Fundamentally, a <em>Date</em> object is a number:<a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a> it counts the number of days that have elapsed since a fixed date. It does not care what the year is, what the month is, or what day of the month it is. It does not care how the date is displayed to the user. All those things are supplied by the <code>print()</code> method, and are not part of the <em>Date</em> itself.</p>
<p><br></p>
<h3 id="r-the-posixct-class">[R] The POSIXct class</h3>
<p>A date is a comparatively simple thing. When we want to represent dates and time together, we need to know the time of day, and we might need to store information about the timezone as well (more on that later). Base R has two different classes for representing this, <em>POSIXct</em> and <em>POSIXlt</em>. These names used to confuse me a lot. <a href="https://en.wikipedia.org/wiki/POSIX">POSIX</a> stands for portable operating system interface, and its a set of standards used to help operating systems remain compatible with each other. In this context though, its not very meaningful: all it says yup we use unix time.</p>
<p>The more important part of the name is actually the <a href="https://stackoverflow.com/questions/44778721/what-do-ct-and-lt-in-posixct-and-posixlt-mean">ct versus lt</a> part. Lets start with <em>POSIXct</em>. The ct in <em>POSIXct</em> stands for calendar time: internally, R stores the number of seconds<a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup>30</sup></a> that have elapsed since 1970-01-01 00:00 UTC.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>now</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 14:38:55 AEDT&quot;</code></pre>
</div>
<p>If I peek under the hood using <code>unclass()</code> heres what I see:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 1646710736</code></pre>
</div>
<p>There are no attributes attached to this object, it is simply a count of the number of seconds since that particular moment in time. However, it doesnt necessarily have to be this way: a <em>POSIXct</em> object is permitted to have a tzone attribute, a <em>character</em> string that specifies the timezone that is used when printing the object will be preserved when it is converted to a <em>POSIXlt</em>.</p>
<p>Nevertheless, when I created the <code>now</code> object by calling <code>Sys.time()</code>, no timezone information was stored in the object. The fact that it appears when I print out <code>now</code> occurs because the <code>print()</code> method for <em>POSIXct</em> objects prints the time with respect to a particular timezone. The default is to use the system timezone, which you can check by calling <code>Sys.timezone()</code>, but you can override this behaviour by specifying the timezone explicitly (for a list of timezone names, see <code>OlsonNames()</code>). So if I wanted to print the time in Berlin, I could do this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>now</span>, tz <span class='op'>=</span> <span class='st'>"Europe/Berlin"</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 04:38:55 CET&quot;</code></pre>
</div>
<p>If you want to record the timezone as part of your <em>POSIXct</em> object rather than relying on the print method to do the work, you can do so by setting the <code>tzone</code> attribute. To illustrate this, lets pretend Im in Tokyo:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/attr.html'>attr</a></span><span class='op'>(</span><span class='va'>now</span>, <span class='st'>"tzone"</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='st'>"Asia/Tokyo"</span>
<span class='va'>now</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 12:38:55 JST&quot;</code></pre>
</div>
<p>The important thing here is that the timezone is metadata used to change the how the time is displayed. Changing the timezone does not alter the number of seconds stored in the <code>now</code> object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 1646710736
attr(,&quot;tzone&quot;)
[1] &quot;Asia/Tokyo&quot;</code></pre>
</div>
<p><br></p>
<h3 id="r-the-posixlt-class">[R] The POSIXlt class</h3>
<p>What about <em>POSIXlt</em>? It turns out that this is a quite different kind of data structure, and it thinks about time in a very different way. The lt in <em>POSIXlt</em> stands for local time, and internally a <em>POSIXlt</em> object is a list that stores information about the time in a way that more closely mirrors how humans think about it. Heres what <code>now</code> looks like when I coerce it to a <em>POSIXlt</em> object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now_lt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/as.POSIXlt.html'>as.POSIXlt</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
<span class='va'>now_lt</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 12:38:55 JST&quot;</code></pre>
</div>
<p>It looks exactly the same, but this is an illusion produced by the <code>print()</code> method. Internally, the <code>now_lt</code> object is a very different kind of thing. To see this, lets see what happens if we print it as if it were a regular <em>list</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>now_lt</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>$sec
[1] 55.52466

$min
[1] 38

$hour
[1] 12

$mday
[1] 8

$mon
[1] 2

$year
[1] 122

$wday
[1] 2

$yday
[1] 66

$isdst
[1] 0

$zone
[1] &quot;JST&quot;

$gmtoff
[1] 32400

attr(,&quot;tzone&quot;)
[1] &quot;Asia/Tokyo&quot; &quot;JST&quot;        &quot;JDT&quot;       </code></pre>
</div>
<p>As you can see, this object separately stores the year (counted from 1900), the month (where January is month 0 and December is month 11), the day of the month (starting at day 1), etc.<a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup>31</sup></a> The timezone is stored, as is the day of the week (Sunday is day 0), it specifies whether daylight savings time is in effect, and so on. Time, as represented in the <em>POSIXlt</em> class, uses a collection of categories that are approximately the same as those that humans use when we talk about time.</p>
<p>It is not a compact representation, and its useful for quite different things than <em>POSIXct</em>. What matters for the current purposes is that <em>POSIXlt</em> is, fundamentally, a <em>list</em> structure, and is not in any sense a timestamp.</p>
<p><br></p>
<h3 id="arrow-the-date32-type">[Arrow] The date32 type</h3>
<p>Okay, now lets pivot over to the Arrow side and see what we have to work with. The <em>date32</em> type is similar  but not identical  to the R <em>Date</em> class. Just like the R <em>Date</em> class, it counts the number of days since 1970-01-01. To see this, lets create an analog of the <code>today</code> <em>Date</em> object inside Arrow, and represent it as a <em>date32</em> type:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>today_date32</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>today</span>, type <span class='op'>=</span> <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>date32</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>today_date32</span>
</code></pre>
</div>
<pre><code>Scalar
2022-03-08</code></pre>
</div>
<p>We can expose the internal structure of this object by casting it to an <em>int32</em>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>today_date32</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int32</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
19059</code></pre>
</div>
<p>This is the same answer we got earlier when I used <code>unclass()</code> to take a peek at the internals of the <code>today</code> object. That being said, there is a subtle difference: in Arrow, the <em>date32</em> type is explicitly a 32-bit integer. If you read through the help documentation for date/time classes in R youll see that R has something a little more complicated going on. The details dont matter for this post, but you should be aware that <em>Dates</em> (and <em>POSIXct</em> objects) are stored as <em>doubles</em>. They arent stored as integers:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/typeof.html'>typeof</a></span><span class='op'>(</span><span class='va'>today</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/typeof.html'>typeof</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;double&quot;
[1] &quot;double&quot;</code></pre>
</div>
<p>In any case, given that the Arrow <em>date32</em> type and the R <em>Date</em> class are so similar to each other in structure and intended usage, it is natural to map R <em>Dates</em> to Arrow <em>date32</em> types and vice versa, and thats what the <strong>arrow</strong> package does by default.</p>
<p><br></p>
<h3 id="arrow-the-date64-type">[Arrow] The date64 type</h3>
<p>The <em>date64</em> type is similar to the <em>date32</em> type, but instead of storing the number of days since 1970-01-01 as a 32-bit integer, it stores the number of milliseconds since 1970-01-01 00:00:00 UTC as a 64-bit integer. Its similar to the <em>POSIXct</em> class in R, except that (1) it uses milliseconds instead of seconds; (2) the internal storage is an <em>int64</em>, not a <em>double</em>; and (3) it does not have metadata and cannot represent timezones.</p>
<p>As you might have guessed, the <em>date64</em> type in Arrow isnt very similar to the <em>Date</em> class in R. Because it represents time at the millisecond level, the intended use of the <em>date64</em> class is in situations where you want to keep track of units of time smaller than one day. Sure, I CAN create <em>date64</em> objects from R <em>Date</em> objects if I want to</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='va'>today</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>date64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
2022-03-08</code></pre>
</div>
<p>but this is quite wasteful. Why use a 64-bit representation that tracks time at the millisecond level when all Im doing is storing the date? Although <em>POSIXct</em> and <em>date64</em> arent exact matches, theyre more closely related to each other than <em>Date</em> and <em>date64</em>. So lets create an Arrow analog of <code>now</code> as a <em>date64</em> object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now_date64</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>date64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>now_date64</span>
</code></pre>
</div>
<pre><code>Scalar
2022-03-08</code></pre>
</div>
<p>The output is printed as a date, but this is a little bit misleading because it doesnt give you a good sense of the level of precision in the data. Again we can peek under the hood by explicitly casting this to a 64-bit integer:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now_date64</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
1646710735524</code></pre>
</div>
<p>This isnt a count of the number of days since the unix epoch, its a count of the number of milliseconds. It is essentially the same number, divided by 1000, as the one we obtained when I typed <code>unclass(now)</code>.</p>
<p>However, theres a puzzle here that we need to solve. Lets take another look at <code>unclass(now)</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 1646710736
attr(,&quot;tzone&quot;)
[1] &quot;Asia/Tokyo&quot;</code></pre>
</div>
<p>This might strike you as very weird. On the face of it, what has happened is that I have taken <code>now</code> (which ostensibly represents time at second-level precision), ported it over to Arrow, and created an object <code>now_date64</code> that apparently knows what millisecond it is???? How is that possible? Does Arrow have magic powers?</p>
<p>Not really. R is playing tricks here. Remember how I said that <em>POSIXct</em> objects are secretly <em>doubles</em> and not <em>integers</em>? Well, this is where that becomes relevant. Its quite hard to get R to confess that a <em>POSIXct</em> object actually knows the time at a more precise level than to the nearest second but you can get it do to so by coercing it to a <em>POSIXlt</em> object and then taking a peek at the <code>sec</code> variable:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/as.POSIXlt.html'>as.POSIXlt</a></span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span><span class='op'>$</span><span class='va'>sec</span>
</code></pre>
</div>
<pre><code>[1] 55.52466</code></pre>
</div>
<p>Aha! The first few digits of the decimal expansion are the same ones stored as the least significant digits in <code>now_date64</code>. The data was there all along. Even though <code>unclass(now)</code> produces an output that has been rounded to the nearest second, the original <code>now</code> variable is indeed a <em>double</em>, and it does store the time a higher precision! Ultimately, the accuracy of the time depends on the system clock itself, but the key thing to know here is that even though <em>POSIXct</em> times are almost always displayed to the nearest second, they do have the ability to represent more precise times.</p>
<p>Because of this, the default behaviour in <strong>arrow</strong> is to convert <em>date64</em> types (64-bit integers interpreted as counts of milliseconds) to <em>POSIXct</em> classes (which are secretly 64-bit <em>doubles</em> interpreted as counts of seconds).</p>
<p>Right. Moving on.</p>
<p><br></p>
<h3 id="arrow-the-timestamp-type">[Arrow] The timestamp type</h3>
<p>The last of the Arrow date/time types is the <em>timestamp</em>. The core data structure is a 64-bit integer used to count the number of time units that have passed since the unix epoch, and this is associated with two additional pieces of metadata: the time unit used (e.g., seconds, milliseconds,microseconds, nanoseconds), and the timezone. As with the <em>POSIXct</em> class in R, the timezone metadata is optional, but the time unit is necessary. The default is to use microseconds (i.e., <code>unit = "us"</code>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
<span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>timestamp</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"us"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
2022-03-08 03:38:55.524663
Scalar
2022-03-08 03:38:55.524663</code></pre>
</div>
<p>Alternatively, we could use seconds:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>timestamp</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"s"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
2022-03-08 03:38:55</code></pre>
</div>
<p>Its important to recognise that changing the unit does more than change the precision at which the <em>timestamp</em> is printed. It changes the thing that is counted, so the numbers that get stored in the <em>timestamp</em> are quite different depending on the unit. Compare the numbers that are stored when the units are seconds versus when the units are nanoseconds:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>timestamp</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"s"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>timestamp</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"ns"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>int64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Scalar
1646710735
Scalar
1646710735524663296</code></pre>
</div>
<p>Okay, what about timezone?</p>
<p>Recall that <code>now</code> has a timezone attached to it, because I explicitly recorded the <code>tzone</code> attribute earlier. Admittedly I lied and I said I was in Tokyo and not in Sydney, but still, that information is in the <code>now</code> object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 12:38:55 JST&quot;</code></pre>
</div>
<p>When I print the R object it displays the time in the relevant time zone. The output for the Arrow object doesnt do that: the time as displayed is shown in UTC. However, that doesnt mean that the metadata isnt there:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now_timestamp</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now</span><span class='op'>)</span>
<span class='va'>now_timestamp</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Timestamp
timestamp[us, tz=Asia/Tokyo]</code></pre>
</div>
<p>I mention this because this caused me a considerable amount of panic at one point when I thought my timezone information had been lost when importing data from <em>POSIXct</em> into Arrow. Nothing was lost, it is simply that the <strong>arrow</strong> R package prints all timestamps in the corresponding UTC time regardless of what timezone is specified in the metadata.</p>
<p>There is, however, a catch. This worked last time because I was diligent and ensured that my <code>now</code> variable encoded the timezone. By default, a <em>POSIXct</em> object created by <code>Sys.time()</code> will not include the timezone. Its easy to forget this because the <code>print()</code> method for <em>POSIXct</em> objects will inspect the system timezone if the <em>POSIXct</em> object doesnt contain any timezone information, so it can often look like you have a timezone stored in your <em>POSIXct</em> object when actually you dont. When that happens, Arrow cant help you. Because the <em>POSIXct</em> object does not have a timezone (all appearances to the contrary), the object that arrives in Arrow wont have a timezone either. Heres what I mean:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># a POSIXct object with no timezone</span>
<span class='va'>new_now</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span> <span class='co'># has no time zone...</span>
<span class='va'>new_now</span>               <span class='co'># ... but appears to!</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 14:38:55 AEDT&quot;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># an Arrow timestamp with no timezone</span>
<span class='va'>new_now_timestamp</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>new_now</span><span class='op'>)</span>
<span class='va'>new_now_timestamp</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Timestamp
timestamp[us]</code></pre>
</div>
<p>The take-home message in all this is that if youre going to be working in both Arrow and R, and using the <strong>arrow</strong> package for data interchange, youd be well advised to be careful with your <em>POSIXct</em> objects and timezones. They are trickier than they look, and can lead to subtle translation errors if you are not careful!</p>
<p><br></p>
<h3 id="um-but-what-about-posixlt">Um, but what about POSIXlt?</h3>
<p>At long last we come to <em>POSIXlt</em>, which has no clear analog in Arrow. The key idea behind <em>POSIXlt</em> is to represent temporal information in terms of multiple different units: days, weeks, years, seconds, timezones, and so on. Its a very different kind of thing to a <em>POSIXct</em> object in R or a <em>timestamp</em> in Arrow. In R terms, its essentially a <em>list</em>, and as a consequence the default behaviour in <strong>arrow</strong> is to import it as a <em>struct</em> (which serves essentially the same purpose). Heres how that looks:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>scalar</span><span class='op'>(</span><span class='va'>now_lt</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>StructScalar
{sec:double = 55.52466320991516, min:int32 = 38, hour:int32 = 12, mday:int32 = 8, mon:int32 = 2, year:int32 = 122, wday:int32 = 2, yday:int32 = 66, isdst:int32 = 0, zone:string = JST, gmtoff:int32 = 32400}</code></pre>
</div>
<p>The <em>struct</em> object contains named fields that are identical to their <em>POSIXlt</em> equivalents, and whose types have been translated according to the default mappings: <code>sec</code> is a <em>double</em>, <code>min</code> is an <em>int32</em>, <code>hour</code> is an <em>int32</em>, <code>zone</code> is a <em>string</em>, and so on.</p>
<p>This arrangement, where <em>POSIXct</em> maps to <em>timestamp</em> and <em>POSIXlt</em> maps to <em>struct</em>, makes perfect sense when you think about the underlying data structures that <em>POSIXct</em> and <em>POSIXlt</em> encode. Where things can be tricky for the R user is in the mental account keeping. In order to be helpful, R displays <em>POSIXct</em> and <em>POSIXlt</em> objects in exactly the same way:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now</span>
<span class='va'>now_lt</span>
</code></pre>
</div>
<pre><code>[1] &quot;2022-03-08 12:38:55 JST&quot;
[1] &quot;2022-03-08 12:38:55 JST&quot;</code></pre>
</div>
<p>Not only that, because <em>POSIXct</em> and <em>POSIXlt</em> are both subclasses of the <em>POSIXt</em> class, R allows you to perform temporal arithmetic on objects of different types:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>now</span> <span class='op'>-</span> <span class='va'>now_lt</span>
</code></pre>
</div>
<pre><code>Time difference of 0 secs</code></pre>
</div>
<p>This is very convenient from a data analysis perspective, since calculations performed with date/time classes just work even though <em>POSIXct</em> objects are secretly <em>doubles</em> and <em>POSIXlt</em> objects are secretly <em>lists</em>. However, all this happens invisibly. In much the same way that its easy to forget that <em>POSIXct</em> objects may not encode a timezone even though they look like they do, it can be easy to forget that <em>POSIXct</em> and <em>POSIXlt</em> are fundamentally different objects, and they map onto quite different data structures in Arrow.</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-101"></span>
<img src="art/pollen_47_4836.jpg" alt="Art"  />
<p class="caption">
Figure 19: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="duration-types">Duration types</h2>
<p>Any discussion of temporal data is incomplete without a discussion of duration types, which are used to describe a length of time without reference to any fixed origin. The figure below shows the default mappings used by <strong>arrow</strong>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-102"></span>
<img src="img/duration-types.png" alt="Default mappings for duration types" width="960" />
<p class="caption">
Figure 20: Default mappings for duration types
</p>
</div>
</div>
<p><br></p>
<h3 id="r-the-difftime-class">[R] The difftime class</h3>
<p>In base R, the difference between two date/time objects is stored as a <em>difftime</em> object. To give a better illustration of a <em>difftime</em> object, lets create <code>diff</code>, a variable that stores the amount of time elapsed between executing the R markdown chunk that first computed the <code>now</code> variable, and executing the R markdown chunk below:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>new_now</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>rmd_time</span> <span class='op'>&lt;-</span> <span class='va'>new_now</span> <span class='op'>-</span> <span class='va'>now</span>
<span class='va'>rmd_time</span>
</code></pre>
</div>
<pre><code>Time difference of 0.2977576 secs</code></pre>
</div>
<p>Now lets take a look at how its actually stored:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>rmd_time</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 0.2977576
attr(,&quot;units&quot;)
[1] &quot;secs&quot;</code></pre>
</div>
<p>The duration is represented as a <em>double</em> variable, and the <code>"units"</code> attribute is used to specify the time unit that it represents: secs, mins, hours, days or weeks. Unless the user specifies exactly which unit is to be used, R will attempt to make a sensible choice. For instance, if I were to do this,</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hedy_lamarr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/as.POSIXlt.html'>as.POSIXct</a></span><span class='op'>(</span><span class='st'>"1914-11-09 19:30:00"</span>, tz <span class='op'>=</span> <span class='st'>"Europe/Vienna"</span><span class='op'>)</span>
<span class='va'>hedy_age</span> <span class='op'>&lt;-</span> <span class='va'>now</span> <span class='op'>-</span> <span class='va'>hedy_lamarr</span>
<span class='va'>hedy_age</span>
</code></pre>
</div>
<pre><code>Time difference of 39200.38 days</code></pre>
</div>
<p>I would learn that it has been 39200 days since <a href="https://en.wikipedia.org/wiki/Hedy_Lamarr">Hedy Lamarr</a> was born.<a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup>32</sup></a> More to the point, R has guessed that the length of time is sufficiently long that seconds arent the appropriate encoding unit:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>hedy_age</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 39200.38
attr(,&quot;units&quot;)
[1] &quot;days&quot;</code></pre>
</div>
<p><br></p>
<h3 id="arrow-the-duration-type">[Arrow] The duration type</h3>
<p>The <em>difftime</em> class in R has a natural analog in Arrow, the <em>duration</em> type. As usual though, they are not exactly equivalent to one another. An R <em>difftime</em> object stores the value as a <em>double</em>, so it has no problems storing 0.3 as the value and setting the units to be seconds. This doesnt work very well in Arrow because the value is stored as a signed 64 bit integer (<em>int64</em>), and a value of 0.3 seconds will simply round down to a duration of zero seconds. When importing my duration data into Arrow, then, I should be careful to ensure I choose a higher precision unit. If I dont, things can go a little awry:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rmd_time_arrow</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>rmd_time</span><span class='op'>)</span>
<span class='va'>rmd_time_arrow</span>
</code></pre>
</div>
<pre><code>Scalar
0</code></pre>
</div>
<p>Hm. Zero seconds was not exactly the answer I was looking for. It helps a little to take a peek at the data type and see what precisely it is that I have just created:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rmd_time_arrow</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>DurationType
duration[s]</code></pre>
</div>
<p>This reveals my mistake. Ive encoded the time rounded to the nearest second, which is not very useful in this instance. What I really should have done is specify a higher level of precision. To import a <em>duration</em> into Arrow rounded to the nearest microsecond, I can do this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rmd_time_arrow</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>rmd_time</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>duration</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"us"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>rmd_time_arrow</span>
</code></pre>
</div>
<pre><code>Scalar
297757</code></pre>
</div>
<p>Thats a little better! Again, I can inspect the data type and see that the unit of encoding is now set to microseconds:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rmd_time_arrow</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>DurationType
duration[us]</code></pre>
</div>
<p><br></p>
<h3 id="r-the-hmshms-class">[R] The hms::hms class</h3>
<p>So where are we up to in our voyage through the world of dates, times, and durations in the R world? Weve talked about situations where you can specify a fixed date (with the <em>Date</em> class) and situations where you can specify a fixed moment in time (with <em>POSIXct</em> and <em>POSIXlt</em> classes). Weve also talked about situations where you can specify an amount of time without fixing it to a specific date or time (with the <em>difftime</em> class). What we havent talked about is how to store the time of day. In base R you can talk about a date without needing to specify a time, or you can talk about times and dates together, but what you cant do is specify a time on its own without a date.</p>
<p>The <strong>hms</strong> package fixes this by supplying the <em>hms</em> class. Internally, its just a <em>difftime</em> object that counts the number of seconds elapsed since midnight. As I type these words the current time is 14:05:25, and I could create an <em>hms</em> object representing this like so:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time</span> <span class='op'>&lt;-</span> <span class='fu'>hms</span><span class='fu'>::</span><span class='fu'><a href='https://hms.tidyverse.org/reference/hms.html'>hms</a></span><span class='op'>(</span>seconds <span class='op'>=</span> <span class='fl'>25</span>, minutes <span class='op'>=</span> <span class='fl'>5</span>, hours <span class='op'>=</span> <span class='fl'>14</span><span class='op'>)</span>
<span class='va'>hms_time</span>
</code></pre>
</div>
<pre><code>14:05:25</code></pre>
</div>
<p>The nice thing about <em>hms</em> times is that they inherit from <em>difftime</em>, which we can see by checking the class vector for our <code>hms_time</code> object</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>hms_time</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;hms&quot;      &quot;difftime&quot;</code></pre>
</div>
<p>Just to show that there really isnt anything fancy going on, lets strip the class attribute away and let R print out the raw object. As the output here shows, an <em>hms</em> object has the same underlying structure as a regular <em>difftime</em> object:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>hms_time</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 50725
attr(,&quot;units&quot;)
[1] &quot;secs&quot;</code></pre>
</div>
<p><br></p>
<h3 id="arrow-the-time32-and-time64-types">[Arrow] The time32 and time64 types</h3>
<p>What about Arrow?</p>
<p>At a technical level, it would be perfectly possible to translate an <em>hms</em> object in R into an Arrow <em>duration</em> object, but that feels slightly unnatural. The entire reason why the <em>hms</em> class exists in R is that we  the human users  attach special meaning to the duration of time that has elapsed since midnight on an arbitrary day. We call it the time of day, and while technically it is possible to represent the time of day as a duration (or an <em>hms</em> as a <em>difftime</em>), human beings like to treat special things as special for a reason.</p>
<p>Because of this, Arrow supplies two data types that are roughly analogous to the <em>hms</em> class in R, called <em>time32</em> and <em>time64</em>. The <em>time32</em> type stores the time of day as a signed 32-bit integer, which represents the number of seconds (or alternatively, milliseconds) since midnight. By default, the <strong>arrow</strong> package will translate an <em>hms</em> object to a <em>time32</em> type, using seconds as the unit:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time32_s</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>hms_time</span><span class='op'>)</span>
<span class='va'>hms_time32_s</span>
</code></pre>
</div>
<pre><code>Scalar
14:05:25</code></pre>
</div>
<p>As usual, lets just verify that the encoding unit is as expected:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time32_s</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Time32
time32[s]</code></pre>
</div>
<p>Yep, were all good! To switch to milliseconds, I would use a command like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time32_ms</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>hms_time</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>time32</a></span><span class='op'>(</span>unit <span class='op'>=</span> <span class='st'>"ms"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>hms_time32_ms</span>
</code></pre>
</div>
<pre><code>Scalar
14:05:25.000</code></pre>
</div>
<p>Notice that the output shows the time in a little more resolution. I find this a helpful touch, since it provides a visual cue letting me know what the unit is. But just to confirm, lets inspect the type explicitly:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time32_ms</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Time32
time32[ms]</code></pre>
</div>
<p>If you need to represent the time of day at a higher degree of precision, youll want to use the <em>time64</em> type, which (shockingly!) represents the time of day as a signed 64-bit integer. When using the <em>time64</em> class you can choose microseconds (<code>unit = "us"</code>) or nanoseconds (the default, <code>unit = "ns"</code>) as the unit:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time64_us</span> <span class='op'>&lt;-</span> <span class='fu'>scalar</span><span class='op'>(</span><span class='va'>hms_time</span>, <span class='fu'><a href='https://arrow.apache.org/docs/r/reference/data-type.html'>time64</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>hms_time64_us</span>
</code></pre>
</div>
<pre><code>Scalar
14:05:25.000000000</code></pre>
</div>
<p>The display is showing more trailing zeros, so you can already be sure that the encoding unit has changed. So the only real question you might have pertains to the author. Will she be tediously predictable and check the data type yet again to verify that the encoding unit is nanoseconds, just like she has done every time before? Yes. Yes she will:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>hms_time64_us</span><span class='op'>$</span><span class='va'>type</span>
</code></pre>
</div>
<pre><code>Time64
time64[ns]</code></pre>
</div>
<p>She is quite tiresome at times.</p>
<p>In essence, the <strong>arrow</strong> defaults are set up such that if you choose <code>time32()</code> when going from R to Arrow without specifying a unit, you will end up with the lowest precision representation of time (rounded to the nearest second), whereas if you do the same with <code>time64()</code> you end up with the highest precision (nanosecond level) representation. When going the other way, <strong>arrow</strong> will map <em>time32</em> types and <em>time64</em> types to hms objects, and the end result is that the time of day will be stored as a <em>double</em>.</p>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-120"></span>
<img src="art/pollen_47_4783.jpg" alt="Art"  />
<p class="caption">
Figure 21: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="other-types">Other types</h2>
<p>As with any story told by humans, this one is incomplete. When I started writing this post I had the ambition to cover every single line in the <a href="https://arrow.apache.org/docs/r/articles/arrow.html#mapping-of-r-arrow-types">Table of R/Arrow mappings</a> shown in the <strong>arrow</strong> documentation. I didnt quite get there in the end, and there are a few missing cases. Ill briefly mention them here:</p>
<ul>
<li><p>Arrow possesses a null value used to represent missing data, and behaves similarly to <code>NA</code> in R. In base R there are several different <code>NA</code> values, corresponding to the different atomic types: <code>NA_logical</code>, <code>NA_character</code>. The way this is handled in <strong>arrow</strong> is to rely on the <strong>vctrs</strong> package. Specifically, in <strong>vctrs</strong> there is a <em>vctrs_unspecified</em> class that works very well here, so Arrow <em>nulls</em> map to <em>vctrs_unspecified</em> and vice versa. In practice, this is where <code>NA</code> values enter into the picture.</p></li>
<li><p>In R there is the concept of the <em>raw</em> type used to represent bytes. Arrow doesnt have a natural equivalent of this, but the closest is an unsigned 8-bit integer, so the default is to map <em>raw</em> to <em>uint8</em>.</p></li>
<li><p>I havent talked about <em>factors</em> at all, and frankly I probably should have. My only excuse is exhaustion. The post was getting very long and I ran out of energy. The analog of <em>factors</em> in Arrow is the <em>dictionary</em> type. Theyre not exact mirrors of each other so its worth reading the documentation, but its close enough that <em>factors</em> are mapped to <em>dictionaries</em> and vice versa.</p></li>
<li><p>R and Arrow both allow more complicated data structures to be included as columns within a <em>data frame</em> (or <em>Table</em>). For example, in R each element of a column can itself be a <em>data frame</em>. In such cases, the default in <strong>arrow</strong> is to map each R <em>data frame</em> onto an Arrow <em>struct</em>. Again, this is one where its worth reading the documentation, because there are some subtleties with how things like <em>list</em> columns are handled.</p></li>
</ul>
<p><br><br></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-121"></span>
<img src="art/pollen_47_4784.jpg" alt="Art"  />
<p class="caption">
Figure 22: Art
</p>
</div>
</div>
<p><br><br></p>
<h2 id="the-magic-goes-away">The magic goes away</h2>
<blockquote>
<p>Being in love ruins my judgement. It takes my mind off what Im doing, and I ruin spells <br>   Mirandee, from <a href="https://en.wikipedia.org/wiki/The_Magic_Goes_Away">The Magic Goes Away</a> by Larry Niven</p>
</blockquote>
<p>When I first started using <strong>arrow</strong>, it was the magic I loved most. Everything just worked. I could move data between R and Arrow without having to think, I could manipulate enormous data sets using <strong>dplyr</strong> syntax that Id never even be able to load into R, and I never had to look under the hood. Magic is always compelling. It is delightful. It makes the user feel joy, and its the experience the developer wants to provide.</p>
<p>But as any teacher will tell you, the magic always goes away. There comes a time when you have to sit down and read the manuals. You have to understand how the magic works, and when you do understand you realise there is no magic. At best, there is design. A system can work using all the default settings because it has been thoughtfully designed, but you will eventually encounter situations when the defaults dont apply to you. Its taken me some time to piece all this together, and at the end of the process I feel a lot more confident in my judgment. Having a deeper understanding of data types in Arrow and R is useful to me, even if Im only using the default schemas.</p>
<p>I hope the post is helpful for anyone else following a similar path.<a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a> <!--
- https://arrow.apache.org/docs/r/articles/arrow.html
- https://arrow.apache.org/docs/cpp/api/datatype.html
--></p>
<div class="layout-chunk" data-layout="l-body">

</div>
<!--------------- appendices ----------------->
<div class="layout-chunk" data-layout="l-body">
<h2 class="appendix" id="last-updated">Last updated</h2>
<p>2022-03-08 14:38:56 AEDT</p>
<h2 class="appendix" id="details">Details</h2>
<p><a href="https://github.com/djnavarro/distill-blog/tree/master/_posts/2022-03-04_data-types-in-arrow-and-r/index.Rmd">source code</a>, <a href="https://github.com/djnavarro/distill-blog/tree/master/_renv/_posts/2022-03-04_data-types-in-arrow-and-r/renv.lock">R environment</a></p>
</div>
<!--------------- miscellanea ----------------->
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="sourceCode" id="cb91"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>To be honest, if my goal had been to read the data into Arrow, there was never a need to read it into R in the first place. The code <code>read_csv_arrow("magicians.csv", as_data_frame = FALSE)</code> would create the <em>Table</em> object directly with no need for an intermediary in R. However, for the purposes of this post Im pretending that I have data in R that I want to transfer to Arrow in order to talk about the translation process, so Im doing things in a rather inefficient way. On top of that, theres a whole extra layer of complexity Im hiding here that relates to ALTREP vectors backed by Arrow. However, thats a topic for a future post. We can only unravel the magical cloak one thread at a time!<a href="#fnref1" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn2" role="doc-endnote"><p>Early in the writing process for this post I talked to the very lovely Jon Keane about this, and they pointed out that theres a big difference in the read functions in <strong>arrow</strong> and the translate functions. The code in the <code>read_*()</code> functions is complicated: it handles everything for you because reading the data is a constrained task and the developers can optimise almost everything for you, including the strange edge cases. Translation is harder, and theres less the developers can do to support it. As a consequence, the code underpinning <code>schema()</code> is much simpler. It takes care of choices for you when those choices are obvious, but it leaves all the edge cases for you to deal with. There are a lot of weird edge cases because translating between languages is under-determined. Edge cases are left to the user because only the user knows the context.<a href="#fnref2" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn3" role="doc-endnote"><p>If you have never watched <em>The Magicians</em> I really need to emphasise that it was a really, really weird show and this is nowhere near as implausible as it might sound. I have literally scared off men who had previously been quite keen on me by making them watch this show. Not kidding.<a href="#fnref3" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn4" role="doc-endnote"><p>Back my former life as an mathematical psychologist I studied this stuff for a living, and wrote an <a href="https://djnavarro.net/papers/">absurd number of academic papers</a> on how people learn and represent categories. What I <em>wanted</em> to understand was the relationship between human and machine learning, between natural and artificial intelligence, and so on. What I <em>actually</em> learned is that humans and machines are both super weird.<a href="#fnref4" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn5" role="doc-endnote"><p>At this point I feel compelled to point out that while I may <em>appear</em> to be a bright young thing with little experience of the world, I am in fact a 44 year old woman and former academic who has read quite a few papers on algorithmic information theory and related fields. So, if you happen to be thinking thoughts along the lines of aha, she doesnt know about Turing equivalence! and are considering explaining it to me please dont. This is one of those situations where that pesky little finite length prefix code required to allow machine P to simulate machine Q actually matters, and sometimes finite includes values like staggeringly, painfully large. As I used to wearily tell my students, in real life you cant ignore the <span class="math inline">\(O(1)\)</span> terms.<a href="#fnref5" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn6" role="doc-endnote"><p>As an aside, Michel Foucault actually refers to this Borges passage in the preface to his famous work <a href="https://en.wikipedia.org/wiki/The_Order_of_Things"><em>The Order of Things: An Archaeology of the Human Sciences</em></a> on how different cultures and historical periods viewed the world from fundamentally different perspectives. According to Foucault, Borges essay shattered  all the familiar landmarks of thought  our thought, the thought that bears the stamp of our age and our geography  breaking up all the ordered surfaces and all the planes with which we are accustomed to tame the wild profusion of existing things. Seems fair to say that Borges essay was not without its admirers.<a href="#fnref6" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn7" role="doc-endnote"><p>Much like the Honourable Member for Kennedy, this <a href="https://www.youtube.com/watch?v=1i739SyCu9I">let a thousand OOP systems bloom</a> philosophy has made me cry many times: sometimes from joy, often from frustration.<a href="#fnref7" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn8" role="doc-endnote"><p>The typographical notation for R6 varies because the term can be used to refer to the OOP system itself (which I denote as R6), but could also refer to the <strong>R6</strong> package or the <em>R6</em> object type.<a href="#fnref8" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn9" role="doc-endnote"><p>Note that the <code>Table</code> object is not a <em>Table</em>: it is the class prototype for <em>Table</em> objects, and is therefore classed <em>R6ClassGenerator</em>. The same is true for <code>Scalar</code>, <code>Schema</code>, <code>ChunkedArray</code>, etc.<a href="#fnref9" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn10" role="doc-endnote"><p>Should I take this opportunity to discuss the fact that this means that what R actually implements is a <a href="https://en.wikipedia.org/wiki/Three-valued_logic">three valued logic</a>? No.No I should not. I am going to think it very loudly though.<a href="#fnref10" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn11" role="doc-endnote"><p>Lest anyone think I am too wanton in my use of footnotes in tech blogging, I will simply mention that Dan has a 77-footnote <a href="https://dansblog.netlify.app/posts/2021-11-24-getting-into-the-subspace/">blog post on Gaussian Processes</a>. I am the <em>nice</em> queer in the room.<a href="#fnref11" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn12" role="doc-endnote"><p>There is also an R6 method you could use here. <code>snowpiercer$as_vector()</code> would produce exactly the same answer.<a href="#fnref12" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn13" role="doc-endnote"><p>Okay that was a tortured metaphor and one that I probably dont want to push too far given that <em>Snowpiercer</em> is a terrifyingly dark show filled with horrible, horrible people. But Im nice though. Honest! Would I lie to you?<a href="#fnref13" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn14" role="doc-endnote"><p>Rest assured, dear reader, while I am entirely aware of the distinction between countably and uncountably infinite sets, and have been forced to learn more about the cardinality of transfinite numbers than any human deserves to endure, I will not be discussing any of that in this post. The word infinite is perfectly serviceable for our purposes, and if anyone even TRIES to discuss this with me further on twitter I will be forced to engage the services of a very unpleasant lawyer<a href="#fnref14" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn15" role="doc-endnote"><p>The desert of the real phrase in the title of the section refers to the real numbers, but its also a quote from <em>Simulacra and Simulation</em> and <a href="https://en.wikipedia.org/wiki/The_Matrix"><em>The Matrix</em></a>. Obviously I encountered it in <em>The Matrix</em> first because, all appearances to the contrary, I am uncultured swine.<a href="#fnref15" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn16" role="doc-endnote"><p>At this point it is traditional to make a joke about Zenos paradox of <a href="https://en.wikipedia.org/wiki/Zeno%27s_paradoxes#Achilles_and_the_tortoise">Achilles and the Tortoise</a> and honestly I did try, but to come up with a good joke I first had to get half an idea, and then I had to refine it half way to being a better idea, and then I had to refine that half way and I guess I never quite got there in the end. Sorry.<a href="#fnref16" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn17" role="doc-endnote"><p>Sigh. Technically, this is the last bit. R uses a <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a> representation here which I have flipped to a big-endian format so that it can be read from left to right, but for the love of all that is good and precious in this world please let me simplify a few things okay?<a href="#fnref17" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn18" role="doc-endnote"><p>Okay, if you were reading closely earlier you might be thinking this is wrong and the range should be -1023 to 1024. The reason its not is that those to values are reserved for special numbers.<a href="#fnref18" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn19" role="doc-endnote"><p>I still think Man Tissa would make a good drag king name, though Ive been unreliably informed that it may sound odd to Norwegians.<a href="#fnref19" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn20" role="doc-endnote"><p>In fact, one of the obnoxious things about the reals (which are uncountably infinite) is that almost all reals have infinitely long mantissas. Even if you had a infinite number of digits to work with (a countably infinite set) youre still in trouble. Everything sucks, real numbers are almost surely uncomputable (yes thats an actual result), and I dont want to think about it any more and I need a lie down.<a href="#fnref20" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn21" role="doc-endnote"><p>Okay, so contrary to my stated intentions weve actually ended up quite a long way down into the IEEE 754 standard, so I might as well make an extra observation while were down here. Tests of floating point equality arent tests of mathematical equality. Theyre really just checks that the absolute difference between two numbers is smaller than the <a href="https://en.wikipedia.org/wiki/Machine_epsilon">machine precision</a>. The value of the machine precision is stored in R as <code>.Machine$double.eps</code>.<a href="#fnref21" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn22" role="doc-endnote"><p>Some precision is needed here: in this post I am using the names that appear in the <a href="https://arrow.apache.org/docs/r/reference/data-type.html">documentation to the <strong>arrow</strong> R package</a>. Im doing this because the intended audience is an R user who wants to use the <strong>arrow</strong> package to interact with Arrow. However, you should be aware that these types are given slightly different names in the C++ <a href="https://arrow.apache.org/docs/cpp/api/datatype.html">documentation to <strong>libarrow</strong></a> to which <strong>arrow</strong> provides bindings. In that documentation the terminology is as follows: <em>float64</em> is called <em>double</em>, <em>float32</em> is called <em>float</em>, and <em>float16</em> is called <em>half-float</em>.<a href="#fnref22" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn23" role="doc-endnote"><p>They are both little-endian too.<a href="#fnref23" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn24" role="doc-endnote"><p>Thats assuming were writing numbers in Arabic number system. I suppose it would be different if our orthographic representations adopted the <a href="http://www.mathematicsmagazine.com/Articles/TheSumerianMathematicalSystem.php">Sumerian sexagesimal notation</a>. Admittedly, neither R nor Arrow existed at the time, so its a moot point. All Im really saying is that decimal systems are no less arbitrary than binary ones. The problem arises because of the mismatch, not because one encoding is inherently better than the other.<a href="#fnref24" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn25" role="doc-endnote"><p>As noted in the R internals manual, the specific data structure is referred to as a <a href="https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Encodings-for-CHARSXPs">CHARSXP</a>. For the purposes of the current post Im pretending that character strings are always encoded as UTF-8 because theres no need to complicate matters by talking about things like Latin-1, but be aware that R does support those things. If youre looking for a good overview of what UTF-8 encoding is all about, this blog post on <a href="https://deliciousbrains.com/how-unicode-works/">how unicode works</a> is helpful.<a href="#fnref25" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn26" role="doc-endnote"><p>More strictly, it is a symbol that points to an object. R makes a distinction between the symbol and the object to which it links, and allows multiple labels to point at the same object. Theres an excellent discussion of this in <a href="https://adv-r.hadley.nz/names-values.html">Chapter 3 of <em>Advanced R</em></a><a href="#fnref26" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn27" role="doc-endnote"><p>Once again, theres a little terminology to explain because theres some inconsistency in how the types are referred to in the Arrow C++ documentation and the <strong>arrow</strong> R package documentation. In the <a href="https://arrow.apache.org/docs/cpp/api/datatype.html">list of data types</a> for <strong>libarrow</strong> youll find references to <em>string</em> types and <em>large_string</em> types. However, in <a href="https://arrow.apache.org/docs/r/reference/data-type.html">list of data types</a> documentation for the <strong>arrow</strong> R package youll see the same data types referred to as <em>utf8</em> and <em>large_utf8</em>.<a href="#fnref27" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn28" role="doc-endnote"><p>No I am not going to talk about them in this post. Masochist though I may be, nobody loves that much pain. If you are curious you will simply have to wait for a later post!<a href="#fnref28" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn29" role="doc-endnote"><p>Perhaps surprisingly, this number is encoded as a <em>double</em> and not an <em>integer</em>.<a href="#fnref29" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn30" role="doc-endnote"><p>Again, this is stored as a <em>double</em> and not an integer. You can verify this with the command <code>typeof(Sys.time())</code><a href="#fnref30" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn31" role="doc-endnote"><p>A little counterintuitively, the value of <code>sec</code> ranges from 0 to 61, presumably because <a href="https://en.wikipedia.org/wiki/Leap_second">leap seconds</a> are a thing. I am NOT going to torture myself with that one today. My life has quite enough torture in it already.<a href="#fnref31" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn32" role="doc-endnote"><p>Yes, I looked up her <a href="https://www.astro.com/astro-databank/Lamarr,_Hedy">time and location of birth</a> on an astrology website. I am, after all, a queer. I feel that I have been quite clear on this, and being weird about astrology it is one of the fine traditions of our people.<a href="#fnref32" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn33" role="doc-endnote"><p>A thank you to Jon Keane, Steph Hazlitt, and Neal Richardson for helpful conversations, encouragement, and feedback that have greatly improved the post.<a href="#fnref33" class="footnote-back" role="doc-backlink"></a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="updates-and-corrections">Corrections</h3>
  <p>If you see mistakes or want to suggest changes, please <a href="https://github.com/djnavarro/distill-blog/issues/new">create an issue</a> on the source repository.</p>
  <h3 id="reuse">Reuse</h3>
  <p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. Source code is available at <a href="https://github.com/djnavarro/distill-blog/">https://github.com/djnavarro/distill-blog/</a>, unless otherwise noted. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Navarro (2022, March 4). Notes from a data witch: Data types in Arrow and R. Retrieved from https://blog.djnavarro.net/data-types-in-arrow-and-r</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{navarro2022data,
  author = {Navarro, Danielle},
  title = {Notes from a data witch: Data types in Arrow and R},
  url = {https://blog.djnavarro.net/data-types-in-arrow-and-r},
  year = {2022}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
