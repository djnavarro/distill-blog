---
title: "R scripts for twitter blocks" # <---- UPDATE ME
description:
  Neque porro quisquam est qui dolorem ipsum quia dolor sit amet, 
  consectetur, adipisci velit # <---- UPDATE ME
author:
  - first_name: "Danielle"
    last_name: "Navarro"
    affiliation: Voltron Data
    affiliation_url: https://voltrondata.com
    orcid_id: 0000-0001-7648-6578
    url: https://djnavarro.net
date: 2022-02-05
preview: img/jeremy-bezanger-Nh1tBGgEcG4-unsplash.jpg  # <---- UPDATE ME 
creative_commons: CC BY
citation_url: https://blog.djnavarro.net/r-scripts-for-twitter-blocks 
repository_url: https://github.com/djnavarro/distill-blog/
output:
  distill::distill_article:
    self_contained: false
params:
  slug: r-scripts-for-twitter-blocks
  date: 2022-02-05
  repo: djnavarro/distill-blog
  site: https://blog.djnavarro.net/
---

<!----

checklist:
  - check the "update me" messages in YAML above
  - initialise the _renv folder with refinery::renv_new("name of post folder")
  - populate the lockfile with refinery::renv_snapshot("name of post folder")
  - update the _renv folder from snapshot with refinery::restore("name of post folder")

---->


<!--------------- setup post ----------------->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
refinery::renv_load(paste(params$date, params$slug, sep = "_"))
library(rtweet)
```


<!--------------- post ----------------->

Twitter is a complicated place. I've met some of my closest friends through twitter, it's the place where I keep in touch with my professional community, and it's an important part of my work as a developer advocate at Voltron Data. But it's also a general purpose social media site, and there is a lot of content out there I prefer not to see. In particular, because I'm transgender and have absolutely no desire to participate in or even view the public debate that surrounds trans lives, I go to some lengths to ensure that content of that kind doesn't appear on my twitter feed. On my primary account (where, with one exception, I don't block anyone) I use the twitter mute functionality to hide that content; on my private alt account, however, I use blocks extensively. In this post I'll briefly talk about the scripts I use to manage this from R using the [rtweet](https://docs.ropensci.org/rtweet/) package.

## Warning: this is off-label usage


## Setting up

First, make sure you have the [developer version of rtweet](https://github.com/ropensci/rtweet): the scripts here rely on the in-development tools. I'm currently using rtweet version 0.7.0.9011. If you don't have it, this is the command to install:

```{r, eval=FALSE}
remotes::install_github("ropensci/rtweet")
```

Step two. The authentication mechanism in the current version of rtweet is a little more streamlined than it used to be. You only need to authenticate once on your machine, as follows: 

```{r, eval=FALSE}
auth_setup_default()
```

Step three is the part that reveals that this is an off-label usage of the rtweet package. I'm going to rely on two unexported functions from rtweet. This is generally a bad idea. It's something you don't do unless you're desperate. But I'm assuming that if you're actually considering doing this rather than reading for curiosity then you're desperate to block out harassment so let's do it:

```{r}
TWIT_post <- rtweet:::TWIT_post
TWIT_paginate_cursor <- rtweet:::TWIT_paginate_cursor
```

I'll call these two functions later. 

## Write a blocking function

Let's write a function that I'll whimsically call `cancel_user()`. You feed it a numerical code that corresponds to the user id (more on that momentarily), and specify whether you want to mute or block that user by setting `type = "mute"` or `type = "block"`. Note that rtweet already has a mute function called `post_mute()` that is more flexible in how you can specify the user; but there is no analog for blocking. From the Twitter perspective, however, the only difference between the two is which API endpoint you want to sent the request to:

```{r}
cancel_user <- function(user, type) {
  api <- c(
    "block" = "/1.1/blocks/create",
    "mute" = "/1.1/mutes/users/create"
  )
  TWIT_post(
    token = NULL,
    api = api[type],
    params = list(user_id = user)
  )
}
```

So as long as you know the numeric "user id" that corresponds to the screen name for an account, you can mute or block them via the `cancel_user()` function. The rtweet package provides a handy `lookup_users()` function that you can employ for this. It returns a data frame containing a bunch of information about the user, but the relevant information is the `user_id` variable. So, if you hate me enough to want to mute or block me on twitter, I'll make it easy on you. Here's my numeric user id:

```{r, eval=FALSE}
lookup_users("djnavarro")$user_id
```
```{r, echo=FALSE}
print("108899342") # yes this is the correct number
```


## Preparing it for use at scale

```{r}
cancel_safely <- purrr::safely(cancel_user)

rate_exceeded <- function(out) {
  if(is.null(out$error)) return(FALSE)
  if(grepl("limit exceeded", out$error$message)) return(TRUE)
  return(FALSE)
}

cancel_verbosely <- function(user, type) {

  msg <- c(
    "block" = "blocking user id",
    "mute" = "muting user id"
  )
  withr::local_options(scipen = 14)
  cli::cli_process_start(paste(msg[type], user))

  repeat {
    out <- cancel_safely(user, type)
    if(rate_exceeded(out)) {
      Sys.sleep(300)
    } else {
      break
    }
  }

  if(is.null(out$result)) {
    cli::cli_process_failed()
  } else{
    cli::cli_process_done()
  }
}
```

## Building the final layer

```{r}
cancel_users <- function(users, type) {
  msg <- c("block" = "blocking ", "mute" = "muting ")
  cat(msg[type], length(users), " users\n...")
  purrr::walk(users, cancel_verbosely, type = type)
}

list_cancelled <- function(type, n_max, ...) {
  api <- c(
    "block" = "/1.1/blocks/ids",
    "mute" = "/1.1/mutes/users/ids"
  )
  params <- list(
    include_entities = "false",
    skip_status = "true"
  )
  resp <- TWIT_paginate_cursor(NULL, api[type], params, n = n_max, ...)
  users <- unlist(lapply(resp, function(x) x$ids))
  return(users)
}

cancel_followers <- function(user, type = "block", n_max = 50000, precancelled = numeric(0)) {

  followers <- rtweet::get_followers(user, n = n_max, retryonratelimit = TRUE)
  followers <- followers$from_id

  uncancelled <- setdiff(followers, precancelled)
  uncancelled <- sort(as.numeric(uncancelled))

  cancel_users(uncancelled, type = type)
}
```


### Putting it to work

So if you wanted to block everyone who follows "ObviouslyHatefulPerson" on twitter (yes, I checked, it's not a real account), then you could do this:

```{r, eval=FALSE}
cancel_followers("ObviouslyHatefulPerson")
```

It would look up all their followers and block them one by one. Alternatively, if you prefer to mute rather than block, you can do this:

```{r, eval=FALSE}
cancel_followers("ObviouslyHatefulPerson", type = "mute")
```

As mentioned, though, muting is slow. Twitter imposes rate limits on muting that it doesn't impose on blocks, so the script will hang for long periods of time when you're muting large numbers of people. It's not a very efficient process, but it does work if you're patient enough or desperate enough to spend a couple of months muting a few hundred thousand transphobic twitter accounts.

<!--------------- appendices ----------------->

```{r, echo=FALSE}
refinery::insert_appendix(
  repo_spec = params$repo, 
  name = paste(params$date, params$slug, sep = "_")
)
```


<!--------------- miscellanea ----------------->

```{r redirect, echo=FALSE}
refinery::insert_netlify_redirect(
  slug = params$slug, 
  date = params$date
)
```




