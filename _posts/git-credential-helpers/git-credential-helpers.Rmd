---
title: "Setting up a git credential helper"
description: |
  A short description of the post
params:
  slug: git-credential-helpers
author:
  - first_name: "Danielle"
    last_name: "Navarro"
    url: https://djnavarro.net
    affiliation: UNSW Sydney
    affiliation_url: https://unsw.edu.au
    orcid_id: 0000-0001-7648-6578
date: 2021-08-08
creative_commons: CC BY
citation_url: https://blog.djnavarro.net/git-credential-helpers
repository_url: https://github.com/djnavarro/distill-blog
output:
  distill::distill_article:
    self_contained: false
    toc: true
---


<!--------------- my typical setup ----------------->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r box, echo=FALSE}
# ensure box knows where this post is located
box::set_script_path(
  path = here::here("_posts", params$slug, paste0(params$slug, ".Rmd"))
)

# import utility functions as a module
box::use(../../source/utils[
  set_meta, 
  set_redirect, 
  set_source, 
  set_session,
  set_lockfile,
  set_timestamp
])
```

```{r meta, echo=FALSE}
set_meta(
  title =  "Setting up a git credential helper", 
  description = "..."
)
```

```{r include=FALSE}
aside <- function(text) {
  return(htmltools::tag("aside", list(text)))
}
image <- function(src, width = "100%") {
    htmltools::img(src = src, width = width)
}
```


<!--------------- post begins here ----------------->

There are days when I regret switching to linux as an R user. It's not that I'm particularly enamoured of Apple or Microsoft, and I do enjoy the freedom to tinker that linux systems provide, but without the same resourcing that underpins Windows or Mac OS, I do spent a disproportionate amount my time trying to make my long-suffering Ubuntu laptop do something that would "just work" if I'd gone with one of the more traditional options. But such is life, and besides, there's a case to be made that the time I spend on these things is not wasted: usually, I end up learning something useful. 

This is one of those stories.

```{r, echo=FALSE}
image("https://media.giphy.com/media/DEaRw1U6F4s9O/giphy.gif")
```


## The story is quite short...

### Using GitHub credentials with R

For some years now I have been using git repositories for version control, with some ambivalence to my feelings. I absolutely love version control, and I think GitHub is a fabulous tool, but git itself gives me headaches. It feels counterintuitive and untidy, and I am resistant to learning new git tricks because of that. However, now that GitHub has soft-deprecated password authentication, I find myself needing to learn a new thing if I am going to continue using GitHub as my git remote. Sigh.

Like many R users, whenever I encounter a git problem my first impulse is to see if Jenny Bryan and coauthors have some good advice in the fabulous [Happy Git and GitHub for the useR](https://happygitwithr.com/) book, and true to form, they do. Having decided that I will revert to being an https girl, renouncing my flirtation with ssh, I've found the chapter on [caching https credentials](https://happygitwithr.com/credential-caching.html) extremely useful. The usethis article on [git credentials](https://usethis.r-lib.org/articles/articles/git-credentials.html) is also worth the read. 

The problem can be broken into three parts:

- How do I set up an authentication token on my GitHub account?
- How do I configure my git installation to use the authentication token?
- How do I ensure that R detects these credentials?

Thanks to the fabulous work of the tidyverse team, it's possible for R users to solve the problem in a fairly painless way. The solution has been documented repeatedly, but for the sake of completeness I'll repeat the advice here.

### Setting up the credentials

Whenever I am faced with a problem in life, my first instinct is always to ask "can I do this in R?" Although it has not been very helpful in getting my laundry done, it is a mindset that has served me well in my professional life. So I'll try to do everything within R, which is now quite easy. Step 1 is to set up a GitHub token:

```{r, eval=FALSE}
usethis::create_github_token()
```

This will open GitHub in a browser window, take you to the "create a new token page", and pre-populate all the fields with sensible default values. After accepting these values, the token is created and you'll be given a PAT, a "personal authentication token". It'll look something like this...

```
ghp_dgdfasdklfjsdklfjsadfDKFJASDLKFJ3453
```

You should immediately save this in a secure password manager, like [1password](https://1password.com/), [lastpass](https://www.lastpass.com/), etc, because GitHub will only show it to you this one time.

<br><br><br>

You did save it to your password manager, right?

<br><br><br>

Right?

<br><br><br>

You really might need it again.

<br><br><br>

You really might.

<br><br><br>

Yes, you.

<br><br><br>

All right then.

I'll trust you've taken sensible precautions now, so let's keep going. Step 2 in the process is to configure your git installation to use this token. This is, once again, quite easy:

```{r, eval=FALSE}
gitcreds::gitcreds_set()
```

Upon hitting enter, R will ask you for the PAT. Paste it into the console, hit enter and you are done. Your git installation is now configured to use the token. Yay, let's move onto step 3, which is to ensure that R will recognise and use these credentials. As it turns out, step 3 doesn't require you to do anything, because it happens automatically! The usethis functions like `pr_init()` and `pr_push()` recognise your credentials as soon as gitcreds sets them up and everything works perfectly...

```{r, echo=FALSE}
image("https://media.giphy.com/media/BC87NFCPxG0M0/giphy.gif")
```


## ... unless you're on linux   

If you're on linux, you might find yourself in the same boat I was. The credentials you just set up work flawlessly for about 15 minutes, at which time R complains that it cannot find any credentials and you spend the next 15 minutes crying melodramatically.

When this happened to me I assumed the problem was in my R environment. I spent a long time looking for updates to gitcreds, usethis, and every R package I could think of that might possibly be involved in communicating with git. Nothing worked. The reason nothing worked is that the problem wasn't with R at all... it was git, and in hindsight I realise that the problem is specific to git on linux. All those beautiful people with their fancy Windows and Mac machines won't run into the problem I encountered. They won't spend an entire Saturday trying to git credential management, and they will never know my pain. Curse them and their superior purchasing decisions. 

Just kidding. I love my quirky little Ubuntu box and I have a lot of fun learning how to fix her up every time she sets herself on fire.

```{r, echo=FALSE}
image("https://media.giphy.com/media/4vhF7cLLmu4zC/giphy.gif")
```


### Where did I leave my config?

Although git makes it possible to store configuration locally, at the repository level, I rarely need this flexibility. The relevant information is stored in the global file: on my machine, this is  located at `/home/danielle/.gitconfig`. I can ask git to list these configuration settings, like this

```{bash, eval=FALSE}
git config --global --list
```

and at the start of this exercise the output would have looked like this:

```
user.name=Danielle Navarro
user.email=d.navarro@unsw.edu.au
```

I'm not sure why this is, but I always feel slightly more reassured when I'm able to inspect the configuration file itself. Opening my `.gitconfig` file shows the same information, but the formatting is slightly different in the raw file: 

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
```

To solve the git credential problem, we're going to need to edit this configuration information. Depending on which solution you go with, you might need to install new software too. 

### Don't forget to update git

Before starting, it's a good idea to make sure you have the latest version of git, because older versions won't have the tools you need. As it happens, I had already updated git to the most recent version (2.32.0 at the time of writing), but in case anyone ends up relying on this post, here's how you do it:

```
sudo add-apt-repository ppa:git-core/ppa
sudo apt update
sudo apt install git
```


## Three solutions

### 1. Set a long timeout for the git cache

Recent versions of git are released with a [credential cache](https://git-scm.com/docs/git-credential-cache) that retains your credentials in memory temporarily. The information is never written to disk, and it expires after a time. You can tell git to use this cache as your "credential helper" by typing the following command at the terminal:

```{bash, eval=FALSE}
git config --global credential.helper cache
```

After doing this, my `.gitconfig` file now looks like this:

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache
```

Unfortunately this isn't an ideal solution, because the cache expires after 900 seconds (15 minutes). As soon as the cache expires, git loses track of your GitHub credentials and as a consequence `usethis::pr_push()` suddenly stops working, and you have to set the credentials again by calling `gitcred::gitcred_set()` and entering the PAT again. You did store it in a password manager right? Because if not, you're going to have to create a new one like I did about a dozen times.

A simple solution to this problem is to ask git to store information in the cache for a little bit longer. Instead of 900 seconds, maybe ask for 10 million seconds. That way, you'll only have to refresh the cache using `gitcred::gitcred_set()` once every four months instead of four times an hour. Implementing this solution requires only one line of code at the terminal:


```{bash, eval=FALSE}
git config --global credential.helper 'cache --timeout=10000000'
```

After typing this, my `.gitconfig` file looks like this:

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache --timeout=10000000
```

This is a perfectly functional solution to the problem... "find the thing that normally happens 15 minutes and drag it out for 4 months" may not be the most elegant way to handle it, but it works.


```{r, echo=FALSE}
image("https://media.giphy.com/media/6qt69qcDApRU4/giphy.gif")
```


### 2. Use libsecret credential manager

It puzzled me slightly that this problem only exists for linux computers, so I did a little more reading on how [git manages credentials](https://git-scm.com/book/en/v2/Git-Tools-Credential-Storage). It turns out you don't have to rely on the in-memory cache: you can tell git to use some other program to supply the credentials. This is what all those swanky Mac and Windows people have been doing all along. On Macs, for example, git defaults to using the OS X keychain to store credentials safely on disk. It's possible to do the same thing on linux using [libsecret](https://wiki.gnome.org/Projects/Libsecret) (source on [gitlab](https://gitlab.gnome.org/GNOME/libsecret)) and it's not much harder than the "long cache" trick described in the previous section. 

The first step is ensuring libsecret is installed on your machine. It probably is (or at least, it was on my Ubuntu 20.04 box), but in case it isn't here's the command you need

```{bash, eval=FALSE}
sudo apt install libsecret-1-0 libsecret-1-dev
```

It helps to realise that libsecret isn't an application designed to work with git (i.e., it's not the credential manager), nor is it the [keyring](https://itsfoss.com/ubuntu-keyring/) where the passwords are stored. Rather, it's a library that communicates with the keyring: I found [this post](https://rtfm.co.ua/en/what-is-linux-keyring-gnome-keyring-secret-service-and-d-bus/) useful for making sense of it. So if we want to use libsecret to access the keyring, we're going to need a git credential manager that knows how to talk to libsecret. As it turns out, git comes with one already, you just have to build it using `make`:

```{bash, eval=FALSE}
cd /usr/share/doc/git/contrib/credential/libsecret
sudo make
```

This will build the `git-credential-libsectret` application for you (stored in the same directory), and now all you have to do is tell git to use to manage your GitHub credentials:

```{bash, eval=FALSE}
git config --global credential.helper \
  /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```

After typing that, my `.gitconfig` file looks like this:

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```

At this point we're ready to go. Just in case, it's probably worth checking that R is reading the correct configuration information, which you can do with gitcreds:

```{r, eval=FALSE}
gitcreds::gitcreds_list_helpers()
```
```{r, echo=FALSE}
print("/usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret")
```

If everyone is talking to each other properly, the next time you call `gitcreds::gitcreds_set()`, R will pass your PAT to git, git will pass it to git-credential-libsecret, git-credential-libsecret will pass it to libsecret, and it will end up in your linux keychain. Whenever you need to authenticate and push some commits up to GitHub from R, it should find the credentials the same way.


```{r, echo=FALSE}
image("https://media.giphy.com/media/10c3XjPPw2Kkbm/giphy.gif")
```



### 3. Use GCM core

In the end I decided to go with "git credential manager core" [GCM Core](https://github.com/microsoft/Git-Credential-Manager-Core). It's developed by Microsoft and, perhaps unsurprisingly, it is what GitHub currently [recommends](https://docs.github.com/en/get-started/getting-started-with-git/caching-your-github-credentials-in-git). It's slightly more painful to set up, and the [installation instructions](https://github.com/microsoft/Git-Credential-Manager-Core#linux-install-instructions) are different depending on what flavour of linux you're running. Because I'm on Ubuntu 20.04, I downloaded the .deb file associated with the [most recent release of GCM core](https://github.com/microsoft/Git-Credential-Manager-Core/releases/latest), and then installed directly using the `dpkg` command:

```{bash, eval=FALSE}
sudo dpkg -i <path-to-deb-file>
```

This will build ``git-credential-manager-core` on your system, and once that's done you can ask it to take care of the configuration for you: 

```{bash, eval=FALSE}
git-credential-manager-core configure
```

This will edit the `.gitconfig` file, so for me it now looks like this:

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
[credential "https://dev.azure.com"]
	useHttpPath = true
```

In a happier world you would be done at this point, but we don't live in a happy world. We live in a sick sad world that has global pandemics and pineapple on pizzas. So there's still one job left to do.

Much like the `git-credential-libsecret` application I compiled in the previous section, GCM core is a git credential manager: it communicates with git, but it doesn't store the passwords itself. Instead, it provides you with several [options](https://github.com/microsoft/Git-Credential-Manager-Core/blob/main/docs/linuxcredstores.md). The first option on the list is to connect to a [secret service API](https://specifications.freedesktop.org/secret-service/), which (as far as I can tell) is just a fancy way of referring to a linux keychain. That's basically the same approach that we adopted in the libsecret approach, and as it turns out GCM core actually uses libsecret as the method for communicating with the keychain. So that's the option I went with:

```{bash, eval=FALSE}
git config --global credential.credentialStore secretservice
```

Having done this, my `.gitconfig` file now looks like this:

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
	credentialStore = secretservice
[credential "https://dev.azure.com"]
	useHttpPath = true
```

As before, I can check that R is reading the correct configuration information...

```{r}
gitcreds::gitcreds_list_helpers()
```

...and now I'm ready to go.

Oh the sheer excitement of it all. I do hope I can contain my boundless enthusiasm and joy.


```{r, echo=FALSE}
image("https://media.giphy.com/media/S0l1Ah4cjIdwY/giphy.gif")
```

```{r, echo=FALSE}
image("https://media.giphy.com/media/xrbdBK5A5cIYo/giphy.gif")
```



<!--------------- appendices go here ----------------->

## Last updated {.appendix}

`r set_timestamp("Australia/Sydney")`

## Details {.appendix}

[source code](`r set_source(params$slug)`), [session info](`r set_session(params$slug)`), [lockfile](`r set_lockfile(params$slug)`)


<!--------------- miscellanea ----------------->

```{r redirect, echo=FALSE}
set_redirect(params$slug)
```


