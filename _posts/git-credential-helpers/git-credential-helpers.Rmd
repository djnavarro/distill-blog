---
title: "Setting up a git credential helper"
description: |
  A short description of the post
params:
  slug: git-credential-helpers
author:
  - first_name: "Danielle"
    last_name: "Navarro"
    url: https://djnavarro.net
    affiliation: UNSW Sydney
    affiliation_url: https://unsw.edu.au
    orcid_id: 0000-0001-7648-6578
date: 2021-07-08
creative_commons: CC BY
citation_url: https://blog.djnavarro.net/git-credential-helpers
repository_url: https://github.com/djnavarro/distill-blog
output:
  distill::distill_article:
    self_contained: false
---


<!--------------- my typical setup ----------------->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r box, echo=FALSE}
# ensure box knows where this post is located
box::set_script_path(
  path = here::here("_posts", params$slug, paste0(params$slug, ".Rmd"))
)

# import utility functions as a module
box::use(../../source/utils[
  set_meta, 
  set_redirect, 
  set_source, 
  set_session,
  set_lockfile,
  set_timestamp
])
```

```{r meta, echo=FALSE}
set_meta(
  title =  "Setting up a git credential helper", 
  description = "..."
)
```

```{r include=FALSE}
aside <- function(text) {
  return(htmltools::tag("aside", list(text)))
}
image <- function(src, width = "100%") {
    htmltools::img(src = src, width = width)
}
```


<!--------------- post begins here ----------------->



## Prelude: where did I leave my config?

```{bash, eval=FALSE}
git config --global --list | cat
```

You would probably see output like this

```
user.name=Danielle Navarro
user.email=d.navarro@unsw.edu.au
```

```{bash, eval=FALSE}
subl /home/danielle/.gitconfig
```

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
```

oh and probably good to have the most recent git

```
sudo add-apt-repository ppa:git-core/ppa
sudo apt update
sudo apt install git
```


## Method 1: use git cache with long timeout

https://git-scm.com/docs/git-credential-cache

```{bash, eval=FALSE}
git config --global credential.helper cache
```

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache
```

This works perfectly well, apart from the minor irritation that the cache will expire after 300 seconds and any credentials that you'd stored using `gitcred::gitcred_set()` will vanish. This was the source of my problem. I'd find myself creating a GitHub PAT using `usethis::create_github_token()`, storing it, and everything would work fine... for a little while. Then suddenly R started complaining to me that I didn't have any credentials, leading to many a tear being shed. 

The absolute simplest solution to this problem is discussed in [Happy Git and GitHub for the UseR](https://happygitwithr.com/credential-caching.html#linux-1), and it's as simple as asking git to store credentials in the cache for just a tiny bit longer, say, ten million seconds...

```{bash, eval=FALSE}
git config --global credential.helper 'cache --timeout=10000000'
```

After I do that, my `.gitconfig` file looks like this

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache --timeout=10000000
```

and all is well in the world for almost four months, at which point the credential will vanish. At that point of course you've forgotten how you set it up in the first place, a lot of tears are shed, and you start asking yourself why you didn't buy one of those shiny Macs or Windows boxes that all your friends are using. 

## Intermission: It's just a program



https://git-scm.com/book/en/v2/Git-Tools-Credential-Storage



## Method 2: Use libsecret as your credential manager

Oh noes, I have accidentally deleted my credentials, deleted the credential details from my git configuration file. Halp, whatever shall I do? I could repeat the process, or I could tell git to use a credential manager. This is what all those swanky Mac and Windows people have been doing all along.  


The [gitlab repo](https://gitlab.gnome.org/GNOME/libsecret)

The first step is ensuring libsecret is installed

```{bash, eval=FALSE}
sudo apt install libsecret-1-0 libsecret-1-dev
```

Next you need to build the credential manager

```{bash, eval=FALSE}
cd /usr/share/doc/git/contrib/credential/libsecret
sudo make
```

Last step is to configure git to use `git-credential-libsecret` as the credential manager

```{bash, eval=FALSE}
git config --global credential.helper \
  /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```



```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```

Check from within R

```{r}
gitcreds::gitcreds_list_helpers()
```

Now we can follow the process...

```{r, eval=FALSE}
usethis::create_github_token()
gitcreds::gitcreds_set()
```

Usethis is now happy, and `pr_*()` functions now work as expected...

```{r, eval=FALSE}
usethis::git_sitrep()
```

```{r}
gitcreds::gitcreds_get()
```


## Method 3: Use GCM Core 

In the end I decided to go with [GCM Core](https://github.com/microsoft/Git-Credential-Manager-Core), in part because I've enabled [two-factor authentication](https://github.com/settings/security) on my GitHub account, and also because that's what GitHub [recommends](https://docs.github.com/en/get-started/getting-started-with-git/caching-your-github-credentials-in-git). 
The [installation instructions](https://github.com/microsoft/Git-Credential-Manager-Core#linux-install-instructions) for Linux vary a bit depending on what you're running. Annoyingly for me I'm on Ubuntu 20.04, and wouldn't you know, they don't have a repository for that. So I download the .deb file corresponding to the [most recent release](https://github.com/microsoft/Git-Credential-Manager-Core/releases/latest), and then install it 

```{bash, eval=FALSE}
sudo dpkg -i <path-to-package>
```

Conveniently it will do some configuration for you:

```{bash, eval=FALSE}
git-credential-manager-core configure
```

and now my `.gitconfig` looks like this

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
[credential "https://dev.azure.com"]
	useHttpPath = true
```

Obnoxiously, you're not quite done yet. GCM Core doesn't actually store the credentials itself, and you have [options](https://github.com/microsoft/Git-Credential-Manager-Core/blob/main/docs/linuxcredstores.md) for what you can choose. The first option on the list is something that sounds super cool, the [Secret Service API](https://specifications.freedesktop.org/secret-service/)... which as it happens, is the same thing that libsecret uses, and if you go with this option you're using libsecret anyway...

```{bash, eval=FALSE}
git config --global credential.credentialStore secretservice
```

and now here's my config file

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
	credentialStore = secretservice
[credential "https://dev.azure.com"]
	useHttpPath = true
```

<!--------------- appendices go here ----------------->

## Last updated {.appendix}

`r set_timestamp("Australia/Sydney")`

## Details {.appendix}

[source code](`r set_source(params$slug)`), [session info](`r set_session(params$slug)`), [lockfile](`r set_lockfile(params$slug)`)


<!--------------- miscellanea ----------------->

```{r redirect, echo=FALSE}
set_redirect(params$slug)
```


