---
title: "Setting up a git credential helper"
description: |
  A short description of the post
params:
  slug: git-credential-helpers
author:
  - first_name: "Danielle"
    last_name: "Navarro"
    url: https://djnavarro.net
    affiliation: UNSW Sydney
    affiliation_url: https://unsw.edu.au
    orcid_id: 0000-0001-7648-6578
date: 2021-07-08
creative_commons: CC BY
citation_url: https://blog.djnavarro.net/git-credential-helpers
repository_url: https://github.com/djnavarro/distill-blog
output:
  distill::distill_article:
    self_contained: false
---


<!--------------- my typical setup ----------------->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r box, echo=FALSE}
# ensure box knows where this post is located
box::set_script_path(
  path = here::here("_posts", params$slug, paste0(params$slug, ".Rmd"))
)

# import utility functions as a module
box::use(../../source/utils[
  set_meta, 
  set_redirect, 
  set_source, 
  set_session,
  set_lockfile,
  set_timestamp
])
```

```{r meta, echo=FALSE}
set_meta(
  title =  "Setting up a git credential helper", 
  description = "..."
)
```

```{r include=FALSE}
aside <- function(text) {
  return(htmltools::tag("aside", list(text)))
}
image <- function(src, width = "100%") {
    htmltools::img(src = src, width = width)
}
```


<!--------------- post begins here ----------------->

There are days when I regret switching to linux as an R user. It's not that I'm particularly enamoured of Apple or Microsoft, and I do enjoy the freedom to tinker that linux systems provide, but without the same resourcing that underpins Windows or Mac OS, I do spent a disproportionate amount my time trying to make my long-suffering Ubuntu laptop do something that would "just work" if I'd gone with one of the more traditional options. But such is life, and besides, there's a case to be made that the time I spend on these things is not wasted: usually, I end up learning something useful. 

This is one of those stories.

## Managing GitHub credentials

For some years now I have been using git repositories for version control, with some ambivalence to my feelings. I absolutely love version control, and I think GitHub is a fabulous tool, but git itself gives me headaches. It feels counterintuitive and untidy, and I am resistant to learning new git tricks because of that. However, now that GitHub has soft-deprecated password authentication, I find myself needing to learn a new thing if I am going to continue using GitHub as my git remote. Sigh.

Like many R users, whenever I encounter a git problem my first impulse is to see if Jenny Bryan and coauthors have some good advice in the fabulous [Happy Git and GitHub for the useR](https://happygitwithr.com/) book, and true to form, they do. Having decided that I will revert to being an https girl, renouncing my flirtation with ssh, I've found the chapter on [caching https credentials](https://happygitwithr.com/credential-caching.html) extremely useful. The usethis article on [git credentials](https://usethis.r-lib.org/articles/articles/git-credentials.html) is also worth the read. 

The basic problem is simple, and can be broken into three parts...

- How do I set up an authentication token on my GitHub account?
- How do I configure my git installation to use the authentication token?
- How do I ensure that R detects these credentials?

...and  unless you have the misfortune to be a linux user the solution turns out to be very simple too, thanks to the fabulous work of the tidyverse team. The usual solution to the problem has been documented repeatedly, but for the sake of completeness I'll repeat the advice here.

## Setting up the credentials

Whenever I am faced with a problem in life, my first instinct is always to ask "can I do this in R?" Although it has not been very helpful in getting my laundry done, it is a mindset that has served me well in my professional life. So I'll try to do everything within R, which is now quite easy. Step 1 is to set up a GitHub token:

```{r, eval=FALSE}
usethis::create_github_token()
```

This will open GitHub in a browser window, take you to the "create a new token page", and pre-populate all the fields with sensible default values. After accepting these values, the token is created and you'll be given a PAT, a "personal authentication token". It'll look something like this...

```
ghp_dgdfasdklfjsdklfjsadfDKFJASDLKFJ3453
```

You should immediately save this in a secure password manager, like [1password](https://1password.com/), [lastpass](https://www.lastpass.com/), etc, because GitHub will only show it to you this one time.

Step 2 in the process is to configure your git installation to use this token. This is, once again, quite easy:

```{r, eval=FALSE}
gitcreds::gitcreds_set()
```

Upon hitting enter, R will ask you for the PAT. Paste it into the console, hit enter and you are done. Your git installation is now configured to use the token. Yay!

Step 3 is to ensure that R will recognise and use these credentials, and happily this means there is no step 3... it happens automatically! My usual workflow for a pull request is use the `pr_init()`, `pr_push()`, etc functions from usethis, and they all work perfectly...

## Nothing is simple on linux

...for about 15 minutes, at which time R complains that it cannot find any credentials and I spend another 15 minutes crying. I had assumed the problem was with R somewhere, and spent a long time looking for updates to gitcreds, usethis, and every R package I could think of that could possibly have something to do with git. Nothing worked. The reason nothing worked is that the problem wasn't with R at all... it was git, and in hindsight I realise that the problem is specific to git on linux. All those beautiful people with their fancy Windows and Mac machines won't run into the problem I encountered. They won't spend an entire Saturday trying to git credential management, and they will never know my pain. Curse them and their superior purchasing decisions. 

Just kidding, I love my quirky little Ubuntu box and I had a lot of fun learning how to fix the problem.

## Prelude I: where did I leave my config?

Although git makes it possible to store configuration locally, at the repository level, I rarely need this flexibility. The relevant information is stored in the global file: on my machine, this is  located at `/home/danielle/.gitconfig`. I can ask git to list these configuration settings, like this

```{bash, eval=FALSE}
git config --global --list
```

and at the start of this exercise the output would have looked like this:

```
user.name=Danielle Navarro
user.email=d.navarro@unsw.edu.au
```

I'm not sure why this is, but I always feel slightly more reassured when I'm able to inspect the configuration file itself. Opening my `.gitconfig` file shows the same information, but the formatting is slightly different in the raw file: 

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
```

To solve the git credential problem, we're going to need to edit this configuration information. Depending on which solution you go with, you might need to install new software too. 

## Prelude 2: don't forget to update git

Before starting, it's a good idea to make sure you have the latest version of git, because older versions won't have the tools you need. As it happens, I had already updated git to the most recent version (2.32.0 at the time of writing), but in case anyone ends up relying on this post, here's how you do it:

```
sudo add-apt-repository ppa:git-core/ppa
sudo apt update
sudo apt install git
```


## Method 1: use git cache with long timeout

https://git-scm.com/docs/git-credential-cache

```{bash, eval=FALSE}
git config --global credential.helper cache
```

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache
```

This works perfectly well, apart from the minor irritation that the cache will expire after 300 seconds and any credentials that you'd stored using `gitcred::gitcred_set()` will vanish. This was the source of my problem. I'd find myself creating a GitHub PAT using `usethis::create_github_token()`, storing it, and everything would work fine... for a little while. Then suddenly R started complaining to me that I didn't have any credentials, leading to many a tear being shed. 

The absolute simplest solution to this problem is discussed in [Happy Git and GitHub for the UseR](https://happygitwithr.com/credential-caching.html#linux-1), and it's as simple as asking git to store credentials in the cache for just a tiny bit longer, say, ten million seconds...

```{bash, eval=FALSE}
git config --global credential.helper 'cache --timeout=10000000'
```

After I do that, my `.gitconfig` file looks like this

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = cache --timeout=10000000
```

and all is well in the world for almost four months, at which point the credential will vanish. At that point of course you've forgotten how you set it up in the first place, a lot of tears are shed, and you start asking yourself why you didn't buy one of those shiny Macs or Windows boxes that all your friends are using. 

## Intermission: It's just a program



https://git-scm.com/book/en/v2/Git-Tools-Credential-Storage



## Method 2: Use libsecret as your credential manager

Oh noes, I have accidentally deleted my credentials, deleted the credential details from my git configuration file. Halp, whatever shall I do? I could repeat the process, or I could tell git to use a credential manager. This is what all those swanky Mac and Windows people have been doing all along.  


The [gitlab repo](https://gitlab.gnome.org/GNOME/libsecret)

The first step is ensuring libsecret is installed

```{bash, eval=FALSE}
sudo apt install libsecret-1-0 libsecret-1-dev
```

Next you need to build the credential manager

```{bash, eval=FALSE}
cd /usr/share/doc/git/contrib/credential/libsecret
sudo make
```

Last step is to configure git to use `git-credential-libsecret` as the credential manager

```{bash, eval=FALSE}
git config --global credential.helper \
  /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```



```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret
```

Check from within R

```{r}
gitcreds::gitcreds_list_helpers()
```

Now we can follow the process...

```{r, eval=FALSE}
usethis::create_github_token()
gitcreds::gitcreds_set()
```

Usethis is now happy, and `pr_*()` functions now work as expected...

```{r, eval=FALSE}
usethis::git_sitrep()
```

```{r}
gitcreds::gitcreds_get()
```


## Method 3: Use GCM Core 

In the end I decided to go with [GCM Core](https://github.com/microsoft/Git-Credential-Manager-Core), in part because I've enabled [two-factor authentication](https://github.com/settings/security) on my GitHub account, and also because that's what GitHub [recommends](https://docs.github.com/en/get-started/getting-started-with-git/caching-your-github-credentials-in-git). 
The [installation instructions](https://github.com/microsoft/Git-Credential-Manager-Core#linux-install-instructions) for Linux vary a bit depending on what you're running. Annoyingly for me I'm on Ubuntu 20.04, and wouldn't you know, they don't have a repository for that. So I download the .deb file corresponding to the [most recent release](https://github.com/microsoft/Git-Credential-Manager-Core/releases/latest), and then install it 

```{bash, eval=FALSE}
sudo dpkg -i <path-to-package>
```

Conveniently it will do some configuration for you:

```{bash, eval=FALSE}
git-credential-manager-core configure
```

and now my `.gitconfig` looks like this

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
[credential "https://dev.azure.com"]
	useHttpPath = true
```

Obnoxiously, you're not quite done yet. GCM Core doesn't actually store the credentials itself, and you have [options](https://github.com/microsoft/Git-Credential-Manager-Core/blob/main/docs/linuxcredstores.md) for what you can choose. The first option on the list is something that sounds super cool, the [Secret Service API](https://specifications.freedesktop.org/secret-service/)... which as it happens, is the same thing that libsecret uses, and if you go with this option you're using libsecret anyway...

```{bash, eval=FALSE}
git config --global credential.credentialStore secretservice
```

and now here's my config file

```
[user]
	name = Danielle Navarro
	email = d.navarro@unsw.edu.au
[credential]
	helper = 
	helper = /usr/bin/git-credential-manager-core
	credentialStore = secretservice
[credential "https://dev.azure.com"]
	useHttpPath = true
```

<!--------------- appendices go here ----------------->

## Last updated {.appendix}

`r set_timestamp("Australia/Sydney")`

## Details {.appendix}

[source code](`r set_source(params$slug)`), [session info](`r set_session(params$slug)`), [lockfile](`r set_lockfile(params$slug)`)


<!--------------- miscellanea ----------------->

```{r redirect, echo=FALSE}
set_redirect(params$slug)
```


